# 管理后台搜索列表页面继承方案

## 操作日期

2025年11月23日

## 更新日志

### 2025-11-23 23:05 - 搜索框改为可滚动

- 将搜索框从固定顶部改为可随列表滚动
- 使用 `CustomScrollView` + `SliverToBoxAdapter` 实现
- 提升用户体验，增加可视区域

## 目标

将管理后台所有带搜索功能的列表页面统一为继承同一个基类，减少重复代码，提高可维护性。

## 设计方案

### 核心思想

创建一个 `AdminSearchListPageState` 基类，包含：

- 搜索功能（本地搜索 + API 查询）
- 筛选功能（多条件筛选）
- 排序功能（多字段排序 + 升序/降序）
- 分页功能（滚动加载更多）
- 加载状态管理（加载中/错误/空状态）
- 统一的 UI 组件（搜索栏/列表/底部加载提示）
- **搜索栏可滚动**（不固定在顶部，提升可视区域）

子类只需要：

1. 实现数据获取逻辑 (`fetchData`)
2. 实现列表项 UI (`buildListItem`)
3. 可选：自定义筛选、排序、搜索逻辑

### 文件结构

```
lib/page/low_admin/
├── base/
│   └── admin_search_list_page.dart  // 基类
├── users_list/
│   └── low_admin_users_list_page.dart  // 继承基类
├── user_bought_list/
│   └── low_admin_user_bought_list_page.dart  // 继承基类
├── user_pay_list/
│   └── low_admin_user_pay_list_page.dart  // 继承基类
└── ticket_list/
    └── low_admin_ticket_list_page.dart  // 继承基类
```

## 基类设计

### AdminSearchListPageState<T, W>

```dart
/// 管理后台搜索列表页面基类 State
/// 
/// T - 数据模型类型
/// W - Widget 类型（对应的 StatefulWidget）
abstract class AdminSearchListPageState<T, W extends StatefulWidget>
    extends State<W> {
  
  // ===== 公共属性 =====
  final TextEditingController searchController;
  String searchQuery;
  String? apiQuery;
  List<T> items;
  List<T> filteredItems;
  bool isLoading;
  bool isLoadingMore;
  String? errorMessage;
  // ... 更多属性
  
  // ===== 抽象方法（子类必须实现） =====
  
  /// 获取数据
  Future<List<T>> fetchData(String? query, int offset, int limit);
  
  /// 构建列表项
  Widget buildListItem(BuildContext context, T item);
  
  // ===== 可选方法（子类可覆盖） =====
  
  int get pageSize => 50;
  String get searchHint => '搜索';
  bool get showFilter => false;
  bool get showSort => false;
  
  List<FilterOption> initializeFilters() => [];
  List<SortOption> initializeSortOptions() => [];
  
  bool matchesSearch(T item, String query) => true;
  bool applyFilter(T item, FilterOption filter) => true;
  int compareItems(T a, T b, SortOption sortOption) => 0;
  
  // ===== 实现方法 =====
  
  Future<void> loadData({bool isLoadMore = false}) async {
    // 数据加载逻辑
  }
  
  void applyFiltersAndSort() {
    // 筛选和排序逻辑
  }
  
  @override
  Widget build(BuildContext context) {
    // 直接返回内容，不使用固定顶部的 Column
    return buildContent();
  }
  
  Widget buildContent() {
    // 加载中、错误、空状态的处理...
    
    // 使用 CustomScrollView 让搜索框可滚动
    return CustomScrollView(
      controller: scrollController,
      slivers: [
        // 搜索栏（作为列表的一部分，可滚动）
        SliverToBoxAdapter(
          child: AdminSearchBarComponent(
            hintText: searchHint,
            onSearchChanged: (value) {
              setState(() { searchQuery = value; });
              applyFiltersAndSort();
            },
            onFilterPressed: showFilter ? showFilterSheet : null,
            onSortPressed: showSort ? showSortSheet : null,
            // ...
          ),
        ),
        
        // 列表内容
        SliverList(
          delegate: SliverChildBuilderDelegate(
            (context, index) {
              if (index < filteredItems.length) {
                return buildListItem(context, filteredItems[index]);
              }
              return buildListFooter();
            },
            childCount: filteredItems.length + 1,
          ),
        ),
      ],
    );
  }
}
```

### UI 结构说明

**之前（固定搜索栏）：**

```
Column
├─ AdminSearchBarComponent (固定在顶部)
└─ Expanded(
     └─ ListView
   )
```

**现在（可滚动搜索栏）：**

```
CustomScrollView
├─ SliverToBoxAdapter (搜索栏，可滚动)
│  └─ AdminSearchBarComponent
└─ SliverList (列表内容)
   └─ buildListItem × N
```

**优势：**

- ✅ 滚动时搜索栏会向上移出视图，增加内容可视区域
- ✅ 减少屏幕空间占用，特别是在移动设备上
- ✅ 用户可以专注于浏览内容
- ✅ 需要搜索时向上滚动即可

## 使用示例

### 1. 用户列表页面

```dart
@RoutePage()
class LowAdminUsersListPage extends StatefulWidget {
  const LowAdminUsersListPage({super.key});

  @override
  State<LowAdminUsersListPage> createState() =>
      _LowAdminUsersListPageState();
}

class _LowAdminUsersListPageState extends AdminSearchListPageState<
    UserModel,
    LowAdminUsersListPage> {
  
  late final RestClient _restClient = createAuthenticatedClient();

  // 配置搜索UI
  @override
  String get searchHint => '搜索用户名、邮箱或 ID';

  @override
  bool get showFilter => true;

  @override
  bool get showSort => true;

  // 初始化筛选选项
  @override
  List<FilterOption> initializeFilters() {
    return [
      const FilterOption(label: '已启用', value: 'enabled'),
      const FilterOption(label: '已禁用', value: 'disabled'),
    ];
  }

  // 初始化排序选项
  @override
  List<SortOption> initializeSortOptions() {
    return [
      const SortOption(label: '用户名', value: 'name'),
      const SortOption(label: 'ID', value: 'id'),
      const SortOption(label: '创建时间', value: 'created'),
    ];
  }

  // 获取数据
  @override
  Future<List<UserModel>> fetchData(
    String? query,
    int offset,
    int limit,
  ) async {
    final result = await _restClient.fallback
        .getUserV2ApiV2LowAdminApiUserV2Get(
      q: query,
      limit: limit,
      offset: offset,
    );

    if (result.isSuccess) {
      return result.resultList;
    } else {
      throw Exception(result.message ?? '加载失败');
    }
  }

  // 本地搜索逻辑
  @override
  bool matchesSearch(UserModel item, String query) {
    final lowerQuery = query.toLowerCase();
    return item.userName.toLowerCase().contains(lowerQuery) ||
        item.email.toLowerCase().contains(lowerQuery) ||
        item.id.toString().contains(lowerQuery);
  }

  // 筛选逻辑
  @override
  bool applyFilter(UserModel item, FilterOption filter) {
    if (filter.value == 'enabled' && item.isEnable) return true;
    if (filter.value == 'disabled' && !item.isEnable) return true;
    return false;
  }

  // 排序逻辑
  @override
  int compareItems(UserModel a, UserModel b, SortOption sortOption) {
    switch (sortOption.value) {
      case 'name':
        return a.userName.compareTo(b.userName);
      case 'id':
        return a.id.compareTo(b.id);
      case 'created':
        return a.createdAt.compareTo(b.createdAt);
      default:
        return 0;
    }
  }

  // 构建列表项
  @override
  Widget buildListItem(BuildContext context, UserModel user) {
    return AdminListCardComponent(
      leading: CircleAvatar(
        child: Text(user.userName[0].toUpperCase()),
      ),
      title: user.userName,
      subtitle: '${user.email} • ID: ${user.id}',
      onTap: () => context.router.pushPath('/low_admin/user_v2/${user.id}'),
      badges: [
        if (!user.isEnable)
          StatusBadgeWidget(
            label: '已禁用',
            color: Colors.red,
          ),
      ],
    );
  }
}
```

### 2. 购买记录列表页面

```dart
class _LowAdminUserBoughtListPageState extends AdminSearchListPageState<
    BoughtRecordModel,
    LowAdminUserBoughtListPage> {

  @override
  String get searchHint => '搜索用户ID或订单ID';

  @override
  Future<List<BoughtRecordModel>> fetchData(String? query,
      int offset,
      int limit,) async {
    // 实现购买记录的数据获取
  }

  @override
  Widget buildListItem(BuildContext context, BoughtRecordModel record) {
    // 实现购买记录的列表项UI
  }
}
```

## 优势

### 1. 代码复用

- 所有列表页面共享相同的搜索、筛选、排序、分页逻辑
- 减少重复代码约 70%

### 2. 统一体验

- 所有列表页面的交互方式一致
- UI 风格统一
- 加载状态、错误提示统一

### 3. 易于维护

- 修改基类即可影响所有列表页面
- 新增功能只需在基类中实现一次
- Bug 修复一次，所有页面受益

### 4. 灵活性

- 子类可以覆盖任何方法来自定义行为
- 可以选择性启用筛选、排序功能
- 可以自定义搜索、筛选、排序逻辑

### 5. 类型安全

- 使用泛型确保类型安全
- 编译时检查，减少运行时错误

## 迁移步骤

### 对于现有页面

1. **继承基类**
   ```dart
   class _MyPageState extends AdminSearchListPageState<MyModel, MyPage>
   ```

2. **实现必需方法**
    - `fetchData` - 数据获取
    - `buildListItem` - 列表项 UI

3. **配置可选功能**
    - 设置 `showFilter`, `showSort`
    - 实现 `initializeFilters`, `initializeSortOptions`
    - 实现 `matchesSearch`, `applyFilter`, `compareItems`

4. **删除重复代码**
    - 删除自己的搜索、筛选、排序逻辑
    - 删除加载状态管理代码
    - 删除分页逻辑

### 代码量对比

**之前（独立实现）：**

- 用户列表页面：~450 行
- 购买记录页面：~400 行
- 充值记录页面：~400 行
- 工单列表页面：~400 行
- **总计：~1650 行**

**之后（继承基类）：**

- 基类：~400 行（一次编写，多处复用）
- 用户列表页面：~150 行
- 购买记录页面：~120 行
- 充值记录页面：~120 行
- 工单列表页面：~120 行
- **总计：~910 行（减少 45%）**

## 下一步

1. 完善基类实现
2. 迁移用户列表页面（示例）
3. 迁移其他列表页面
4. 编写单元测试
5. 更新文档

## 相关文件

- `lib/page/low_admin/base/admin_search_list_page.dart` - 基类（待创建）
- `lib/page/low_admin/users_list/` - 用户列表（待迁移）
- `lib/page/low_admin/user_bought_list/` - 购买记录（待迁移）
- `lib/page/low_admin/user_pay_list/` - 充值记录（待迁移）
- `lib/page/low_admin/ticket_list/` - 工单列表（待迁移）

## 注意事项

1. **保持向后兼容**
    - 在迁移过程中，保留原有页面
    - 新页面测试通过后再替换

2. **渐进式迁移**
    - 一次迁移一个页面
    - 确保每个页面都能正常工作

3. **测试覆盖**
    - 为基类编写单元测试
    - 为每个子类编写集成测试

4. **文档更新**
    - 更新开发文档
    - 添加使用示例
    - 记录最佳实践

