# 节点管理界面实现

## 功能概述

新增节点管理界面，使用 `/api/v2/low_admin_api/ss_node/` 系列 API 实现完整的增删改查功能，支持小中大屏幕自适应显示。

## 实现细节

### 1. 路由配置更新

**文件**: `lib/router/low_admin_routes.dart`

- 新增导入: `LowAdminSsNodePage`
- 新增路由: `/low_admin/ss_node`
- 更新 `_selectedIndexForLocation()` 函数以正确映射节点管理页面的导航索引

### 2. 导航菜单更新

**文件**: `lib/page/low_admin/low_admin_layout.dart`

- 在导航项列表中添加节点管理菜单项
- 图标: `Icons.cloud`
- 标签: `节点管理`
- 路由: `/low_admin/ss_node`

### 3. 节点管理页面功能

**文件**: `lib/page/low_admin/ss_node/low_admin_ss_node_page.dart`

#### 核心功能

- **列表查看**: 支持分页和搜索
- **新增节点**: 通过表单对话框创建新节点
- **编辑节点**: 修改已有节点信息
- **删除节点**: 支持确认删除功能
- **刷新**: 下拉刷新或点击刷新按钮

#### API 调用

```dart
// 获取节点列表
getSsNodeListApiV2LowAdminApiSsNodeGet

()

// 创建节点
postSsNodeApiV2LowAdminApiSsNodePost
(
body: SsNodeInput)

// 编辑节点
putSsNodeApiV2LowAdminApiSsNodeNodeIdPut(nodeId: int, body: SsNodeInput)

// 删除节点
deleteSsNodeApiV2LowAdminApiSsNodeNodeIdDelete(nodeId: int)

// 获取单个节点
getSsNodeByIdApiV2LowAdminApiSsNodeNodeIdGet(
nodeId
:
int
)
```

#### 国家代码显示

所有视图都显示节点的国家代码 (ISO 3166-1 alpha-2):

**桌面视图（DataTable）**:

- 在"协议"列之后添加"国家代码"列
- 显示格式: 大写 ISO 代码（如 `HK`, `CN`, `SG`）

**平板/手机视图（Card）**:

- 在卡片详情中添加"国家代码"行
- 显示格式: `国家代码: XX`

### 4. 屏幕适配

使用两个断点实现自适应布局:

```dart

static const double _tabletBreakpoint = 640; // 平板
static const double _desktopBreakpoint = 1100; // 桌面
```

#### 显示逻辑

- **手机** (< 640px): 单列卡片列表
- **平板** (640px - 1100px): 两列卡片网格
- **桌面** (≥ 1100px): 数据表格

### 5. 表单字段

编辑/创建节点时可配置的字段:

| 字段          | 类型     | 必填 | 说明                    |
|-------------|--------|----|-----------------------|
| 节点名称        | String | ✓  | 节点的显示名称               |
| 主机地址        | String | ✓  | 节点服务器地址               |
| 端口          | Int    | ✗  | 节点服务端口                |
| 优先级         | Int    | ✓  | 默认 60000              |
| 节点等级        | Int    | ✓  | 默认 0                  |
| 倍率          | Double | ✓  | 默认 1.0                |
| 协议类型        | Enum   | ✓  | VPN 协议类型              |
| **国家/地区代码** | Enum   | ✓  | ISO 3166-1 alpha-2 代码 |
| 节点启用        | Bool   | ✓  | 默认 true               |
| 节点隐藏        | Bool   | ✓  | 是否对用户隐藏               |
| 速度限制        | String | ✗  | 可选的速度限制               |
| 节点信息        | String | ✗  | 节点描述信息                |
| 备注          | String | ✗  | 管理员备注                 |
| 用户组主机映射     | JSON   | ✗  | 复杂 JSON 配置            |

### 6. 时间处理

所有时间字段遵循项目规范:

- API 使用 UTC 时间
- UI 显示使用本地时间
- 使用 `TZDateTime` 进行时区转换
- 日期格式: `yyyy-MM-dd HH:mm:ss`

### 7. 错误处理

- 网络错误: 显示错误信息和重试按钮
- 表单验证: 必填字段校验
- API 错误: 显示服务器返回的错误信息
- JSON 解析错误: 用户组主机 JSON 格式验证

## 使用说明

### 访问节点管理

1. 进入低权限管理后台
2. 点击左侧导航或抽屉菜单中的"节点管理"
3. 进入 `/low_admin/ss_node` 路由

### 查询节点

1. 在搜索框输入节点名称、备注或 ID
2. 点击"搜索"或按 Enter 键
3. 支持下拉刷新或点击"刷新"按钮

### 添加新节点

1. 点击"新增节点"按钮
2. 填写必填字段（节点名称、主机地址等）
3. 选择国家代码（必填）
4. 点击"保存"提交

### 编辑节点

1. 点击节点卡片或表格行的"编辑"按钮
2. 修改所需字段
3. 点击"保存"提交

### 删除节点

1. 点击节点卡片或表格行的"删除"按钮
2. 在确认对话框中确认删除
3. 系统将立即删除节点

## API 认证

所有 API 调用自动带上访问令牌 (通过 `createAuthenticatedClient()`)

- 认证方式: Bearer Token
- 401 错误处理: 自动跳转登录页

## 依赖

- `dio`: HTTP 客户端
- `timezone`: 时区处理
- `intl`: 国际化和日期格式化
- `go_router`: 路由管理
- 自动生成的 API 模型类

## 注意事项

⚠️ 不修改 `/lib/api` 目录下的代码 - 这些是自动生成的

✅ 所有国家代码通过 `CountryCode` 枚举提供

✅ 国家代码在表单和列表视图中始终显示为大写 ISO 代码

✅ 支持响应式设计，自动适配各种屏幕尺寸

✅ 遵循项目编码规范和时间处理规范

