# 修复购买记录和充值记录页面查询参数传递问题

## 问题描述

在用户详情页点击"购买记录"和"充值记录"按钮后，跳转到对应页面时没有自动搜索指定用户的记录。

## 问题原因

原有实现使用 `Uri.base.queryParameters['q']` 从浏览器 URL 获取查询参数，但在使用 `auto_route` 的
`context.router.pushPath()` 导航时，`Uri.base` 可能无法及时或正确获取到查询参数。

## 解决方案

使用 `auto_route` 的 `@QueryParam` 注解，让路由框架自动将 URL 查询参数注入到页面的构造函数中。

### 修改的文件

#### 1. `lib/page/low_admin/user_bought_list/low_admin_user_bought_list_page.dart`

**修改前：**

```dart
@RoutePage()
class LowAdminUserBoughtListPage extends StatefulWidget {
  const LowAdminUserBoughtListPage({super.key});
// ...
}

class _LowAdminUserBoughtListPageState extends State<LowAdminUserBoughtListPage> {
  @override
  void initState() {
    super.initState();
    WidgetsBinding.instance.addPostFrameCallback((_) {
      _loadQueryFromUrl();
    });
  }

  void _loadQueryFromUrl() {
    final uri = Uri.base;
    final qParam = uri.queryParameters['q'];
    if (qParam != null && qParam.isNotEmpty) {
      _queryController.text = qParam;
      setState(() {
        _queryString = qParam;
      });
    }
  }
}
```

**修改后：**

```dart
@RoutePage()
class LowAdminUserBoughtListPage extends StatefulWidget {
  const LowAdminUserBoughtListPage({
    super.key,
    @QueryParam('q') this.queryParam,
  });

  final String? queryParam;
// ...
}

class _LowAdminUserBoughtListPageState extends State<LowAdminUserBoughtListPage> {
  @override
  void initState() {
    super.initState();
    // 从路由参数初始化查询字符串
    if (widget.queryParam != null && widget.queryParam!.isNotEmpty) {
      _queryController.text = widget.queryParam!;
      _queryString = widget.queryParam;
    }
  }
}
```

#### 2. `lib/page/low_admin/user_pay_list/low_admin_user_pay_list_page.dart`

**修改前：**

```dart
@RoutePage()
class LowAdminUserPayListPage extends StatefulWidget {
  const LowAdminUserPayListPage({super.key});
// ...
}

class _LowAdminUserPayListPageState extends State<LowAdminUserPayListPage> {
  @override
  void initState() {
    super.initState();
    _scrollController.addListener(_onScroll);
    WidgetsBinding.instance.addPostFrameCallback((_) {
      _loadQueryFromUrl();
    });
  }

  void _loadQueryFromUrl() {
    final uri = Uri.base;
    final qParam = uri.queryParameters['q'];
    if (qParam != null && qParam.isNotEmpty) {
      _queryController.text = qParam;
      setState(() {
        _queryString = qParam;
      });
      _fetchRecords();
    } else {
      _fetchRecords();
    }
  }
}
```

**修改后：**

```dart
@RoutePage()
class LowAdminUserPayListPage extends StatefulWidget {
  const LowAdminUserPayListPage({
    super.key,
    @QueryParam('q') this.queryParam,
  });

  final String? queryParam;
// ...
}

class _LowAdminUserPayListPageState extends State<LowAdminUserPayListPage> {
  @override
  void initState() {
    super.initState();
    _scrollController.addListener(_onScroll);

    // 从路由参数初始化查询字符串
    if (widget.queryParam != null && widget.queryParam!.isNotEmpty) {
      _queryController.text = widget.queryParam!;
      _queryString = widget.queryParam;
    }

    // 延迟执行首次加载，确保 UI 已构建完成
    WidgetsBinding.instance.addPostFrameCallback((_) {
      _fetchRecords();
    });
  }
}
```

#### 3. `lib/page/low_admin/low_admin_layout.dart`

由于路由构造函数现在接受可选的查询参数，不再是 `const` 构造函数，需要移除 `const` 关键字。

**修改前：**

```dart
NavigationItem(
  icon: Icons.shopping_bag,
  label: '购买记录',
  route: const LowAdminUserBoughtListRoute(),
),
NavigationItem(
  icon: Icons.account_balance_wallet,
  label: '充值记录',
  route: const LowAdminUserPayListRoute(),
),
```

**修改后：**

```dart
NavigationItem(
  icon: Icons.shopping_bag,
  label: '购买记录',
  route: LowAdminUserBoughtListRoute(),
),
NavigationItem(
  icon: Icons.account_balance_wallet,
  label: '充值记录',
  route: LowAdminUserPayListRoute(),
),
```

## 技术要点

### 1. `@QueryParam` 注解的使用

```dart
@RoutePage()
class MyPage extends StatefulWidget {
  const MyPage({
    super.key,
    @QueryParam('q') this.queryParam, // 从 URL ?q=xxx 获取参数
  });

  final String? queryParam;
}
```

### 2. 路由代码生成

修改页面构造函数后，需要重新生成路由代码：

```bash
dart run build_runner build --delete-conflicting-outputs
```

### 3. 导航方式保持不变

用户详情页的导航代码无需修改：

```dart
Future<void> _navigateToBoughtRecords() async {
  context.router.pushPath('/low_admin/user_bought?q=user_id:${widget.userId}');
}

Future<void> _navigateToPayRecords() async {
  context.router.pushPath('/low_admin/user_pay_list?q=user_id:${widget.userId}');
}
```

## 优势对比

| 方式            | 优点           | 缺点                    |
|---------------|--------------|-----------------------|
| `Uri.base`    | 直接读取浏览器 URL  | 在 SPA 路由中可能不可靠，需要延迟读取 |
| `@QueryParam` | 与路由框架集成，类型安全 | 需要代码生成                |

## 测试建议

1. 在用户详情页点击"购买记录"按钮
2. 确认跳转后的页面搜索框自动填充 `user_id:xxx`
3. 确认列表自动加载该用户的购买记录
4. 重复测试"充值记录"功能

## 相关文件

- `/lib/page/low_admin/user_bought_list/low_admin_user_bought_list_page.dart`
- `/lib/page/low_admin/user_pay_list/low_admin_user_pay_list_page.dart`
- `/lib/page/low_admin/user_detail/low_admin_user_detail_page.dart`
- `/lib/page/low_admin/low_admin_layout.dart` (移除 const 关键字)
- `/lib/router/app_router.dart`
- `/lib/router/app_router.gr.dart` (自动生成)

## 注意事项

1. ✅ 使用 `@QueryParam` 注解声明查询参数
2. ✅ 查询参数使用可空类型 `String?`
3. ✅ 在 `initState` 中从 `widget.queryParam` 获取值
4. ✅ 修改页面构造函数后必须重新运行 `build_runner`
5. ✅ 充值记录页面需要在初始化后触发首次加载
6. ✅ 有查询参数的路由不能使用 `const` 构造函数

