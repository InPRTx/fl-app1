# 实现购买记录的添加功能

## 更新说明

为购买记录管理页面实现了真正的添加功能，现在可以通过 API 创建新的购买记录。

## 更新时间

2025年11月24日

## 变更内容

### 1. 添加了真实的 POST API 调用

**API 接口：**

```
POST /api/v2/low_admin_api/user_bought/
```

**请求体：**

```dart
UserBought {userId: int,shopId: int,createdAt: DateTime, // UTC 时间
moneyAmount: dynamic,}
```

### 2. 实现了完整的添加购买记录对话框

新增 `_AddBoughtRecordDialog` 组件，包含以下功能：

#### 表单字段

| 字段    | 类型       | 验证规则    | 说明               |
|-------|----------|---------|------------------|
| 用户 ID | int      | 必填，纯数字  | 自动填充（如果从用户详情页跳转） |
| 商品 ID | int      | 必填，纯数字  | 需要手动输入           |
| 金额    | decimal  | 必填，数字格式 | 支持小数，例如 10.00    |
| 创建时间  | DateTime | 必填      | 默认当前时间，可选择       |

#### 功能特性

1. **自动填充用户 ID**：
    - 如果从用户详情页跳转（URL 包含 `user_id:123`）
    - 自动提取并填充用户 ID 到表单

2. **日期时间选择器**：
    - 支持选择日期和时间
    - 中文本地化
    - 自动转换为 UTC 时间提交

3. **表单验证**：
    - 所有必填字段验证
    - 数字格式验证
    - 金额格式验证

4. **错误处理**：
    - 显示 API 返回的错误信息
    - 提交失败后保留表单内容
    - 成功后显示提示并刷新列表

### 3. 修改的文件

**文件：** `/lib/page/low_admin/user_bought_list/low_admin_user_bought_list_page.dart`

**主要变更：**

#### 添加必要的导入

```dart
import 'package:fl_app1/api/export.dart';
import 'package:fl_app1/store/service/auth/auth_export.dart';
import 'package:flutter/services.dart';
import 'package:intl/intl.dart';
```

#### 修改 _showAddRecordDialog 方法

**修改前：**

```dart
void _showAddRecordDialog() {
  // 显示 "API 暂不支持" 的提示对话框
}
```

**修改后：**

```dart
Future<void> _showAddRecordDialog() async {
  // 提取用户 ID
  int? presetUserId;
  if (_queryString != null && _queryString!.contains('user_id:')) {
    final match = RegExp(r'user_id:(\d+)').firstMatch(_queryString!);
    if (match != null) {
      presetUserId = int.tryParse(match.group(1)!);
    }
  }

  // 显示添加对话框
  final result = await showDialog<bool>(
    context: context,
    builder: (context) => _AddBoughtRecordDialog(presetUserId: presetUserId),
  );

  // 刷新列表
  if (result == true && mounted) {
    setState(() {
      _queryString = _queryString;
    });
  }
}
```

#### 添加 _AddBoughtRecordDialog 组件

```dart
class _AddBoughtRecordDialog extends StatefulWidget {
  final int? presetUserId;

  const _AddBoughtRecordDialog({this.presetUserId});

  @override
  State<_AddBoughtRecordDialog> createState() =>
      _AddBoughtRecordDialogState();
}

class _AddBoughtRecordDialogState extends State<_AddBoughtRecordDialog> {
  // 表单控制器和状态
  late final RestClient _restClient = createAuthenticatedClient();
  final GlobalKey<FormState> _formKey = GlobalKey<FormState>();

  late final TextEditingController _userIdController;
  late final TextEditingController _shopIdController;
  late final TextEditingController _moneyAmountController;
  late DateTime _createdAt;

  bool _isSubmitting = false;
  String? _errorMessage;

  @override
  void initState() {
    super.initState();
    // 初始化控制器，自动填充用户 ID
    _userIdController = TextEditingController(
      text: widget.presetUserId?.toString() ?? '',
    );
    _shopIdController = TextEditingController();
    _moneyAmountController = TextEditingController();
    _createdAt = DateTime.now();
  }

  Future<void> _submit() async {
    if (!_formKey.currentState!.validate()) return;

    setState(() {
      _isSubmitting = true;
      _errorMessage = null;
    });

    // 构建请求体
    final body = UserBought(
      userId: int.parse(_userIdController.text),
      shopId: int.parse(_shopIdController.text),
      createdAt: _createdAt.toUtc(), // 转换为 UTC
      moneyAmount: _moneyAmountController.text,
    );

    // 调用 API
    final response = await _restClient.fallback
        .postUserBoughtApiV2LowAdminApiUserBoughtPost(body: body);

    if (!mounted) return;

    if (response.isSuccess) {
      Navigator.pop(context, true);
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(content: Text('添加成功')),
      );
    } else {
      setState(() {
        _isSubmitting = false;
        _errorMessage = response.message;
      });
    }
  }

// ... UI 构建代码
}
```

## 使用流程

### 从用户详情页添加记录

1. 进入用户详情页（例如：用户 ID 123）
2. 点击"购买记录"按钮，进入购买记录列表页
3. 点击右下角的"添加记录"浮动按钮
4. 对话框自动填充用户 ID 为 123
5. 输入商品 ID 和金额
6. 选择创建时间（可选，默认当前时间）
7. 点击"添加"按钮
8. 添加成功后，列表自动刷新

### 从购买记录列表页添加记录

1. 直接进入购买记录列表页
2. 点击右下角的"添加记录"浮动按钮
3. 手动输入用户 ID、商品 ID 和金额
4. 选择创建时间（可选）
5. 点击"添加"按钮
6. 添加成功后，列表自动刷新

## 时间处理规范

遵循项目的时间处理规范：

- ✅ UI 中显示和编辑使用本地时间
- ✅ 提交到 API 时自动转换为 UTC 时间 `.toUtc()`
- ✅ 使用 `DateFormat` 格式化显示时间
- ✅ 日期时间选择器使用中文 locale

## 表单验证规则

| 字段    | 验证规则            | 错误提示                   |
|-------|-----------------|------------------------|
| 用户 ID | 非空 + 纯数字        | "请输入用户ID" / "请输入有效的数字" |
| 商品 ID | 非空 + 纯数字        | "请输入商品ID" / "请输入有效的数字" |
| 金额    | 非空 + 数字格式（支持小数） | "请输入金额" / "请输入有效的金额"   |
| 创建时间  | 必填（默认当前时间）      | -                      |

## API 响应处理

### 成功响应

```dart
ErrorResponse {isSuccess: true
,
message: "
添加成功
"
}
```

**处理逻辑：**

- 关闭对话框
- 显示成功提示（SnackBar）
- 刷新购买记录列表

### 失败响应

```dart
ErrorResponse {isSuccess: false
,
message: "
错误信息
"
}
```

**处理逻辑：**

- 保留对话框
- 显示错误信息
- 允许用户修改后重试

## 测试建议

### 基本功能测试

1. **从用户详情页添加**：
    - 验证用户 ID 自动填充
    - 输入商品 ID: 1
    - 输入金额: 10.00
    - 使用默认时间
    - 验证添加成功

2. **手动添加**：
    - 直接进入购买记录列表
    - 手动输入所有字段
    - 验证添加成功

3. **时间选择**：
    - 点击时间字段
    - 选择自定义日期
    - 选择自定义时间
    - 验证时间正确显示和提交

### 验证测试

1. **必填字段验证**：
    - 留空用户 ID → 显示错误
    - 留空商品 ID → 显示错误
    - 留空金额 → 显示错误

2. **格式验证**：
    - 用户 ID 输入非数字 → 无法输入（InputFormatter）
    - 商品 ID 输入非数字 → 无法输入
    - 金额输入字母 → 显示错误

### 错误处理测试

1. **网络错误**：
    - 模拟网络断开
    - 验证错误提示显示

2. **服务器错误**：
    - 输入无效的商品 ID
    - 验证服务器错误信息显示

## 注意事项

1. ✅ 用户 ID 可以自动填充，但也可以手动修改
2. ✅ 金额支持小数，建议使用标准货币格式（如 "10.00"）
3. ✅ 创建时间默认为当前时间，可以自定义
4. ✅ 提交前会自动将本地时间转换为 UTC
5. ✅ 添加成功后自动刷新列表
6. ✅ 失败时保留表单内容，允许重试

## 相关文件

- `/lib/page/low_admin/user_bought_list/low_admin_user_bought_list_page.dart` - 主页面和添加对话框
- `/lib/api/fallback/fallback_client.dart` - API 客户端定义
- `/lib/api/models/user_bought.dart` - UserBought 数据模型

## 与之前的差异

**之前（提示信息）：**

- 点击添加按钮显示 "API 暂不支持添加购买记录功能"
- 无法实际创建记录

**现在（完整功能）：**

- 点击添加按钮显示完整的表单对话框
- 可以输入所有必要字段
- 调用真实的 POST API
- 添加成功后刷新列表
- 支持自动填充用户 ID

## 未来改进建议

1. 可以添加商品选择器，避免手动输入商品 ID
2. 可以添加金额预设选项（常用金额快速选择）
3. 可以添加批量添加功能
4. 可以添加优惠券字段支持

