# 修复依赖冲突

## 操作日期

2025年11月23日

## 问题描述

项目在运行 `flutter pub get` 时遇到依赖冲突错误：

```
Because json_serializable >=6.11.0 requires source_gen >=3.1.0 <5.0.0
and auto_route_generator >=8.1.0 <10.2.4 requires source_gen ^1.5.0 or ^2.0.0,
json_serializable >=6.11.0 is incompatible with auto_route_generator >=8.1.0 <10.2.4.
```

## 问题根源

依赖包之间的传递依赖版本冲突：

- `json_serializable` ^6.11.0 依赖 `source_gen` >=3.1.0 <5.0.0
- `auto_route_generator` ^9.0.0 依赖 `source_gen` ^1.5.0 或 ^2.0.0
- 两者对 `source_gen` 的版本要求不兼容

## 解决方案

升级 `auto_route` 和 `auto_route_generator` 到最新版本，新版本已支持 `source_gen` ^4.0.0。

### 修改内容

在 `pubspec.yaml` 中进行以下修改：

```yaml
dependencies:
  # 从 9.2.2 升级到 10.2.2
  auto_route: ^10.2.2

dev_dependencies:
  # 从 9.0.0 升级到 10.2.4
  auto_route_generator: ^10.2.4
```

### 执行命令

```bash
flutter pub get
```

## 结果

依赖解析成功，相关包版本如下：

- `auto_route`: 10.2.2
- `auto_route_generator`: 10.2.6
- `source_gen`: 4.0.2
- `json_serializable`: 6.11.1

## 注意事项

1. `auto_route` 从 9.x 升级到 10.x 包含了以下破坏性 API 变化：

   **a. MaterialApp.router 配置方式不变**
   ```dart
   // 保持不变，仍使用 delegate() 和 defaultRouteParser()
   MaterialApp.router(
     routerDelegate: appRouter.delegate(),
     routeInformationParser: appRouter.defaultRouteParser(),
     // ...
   )
   ```

   **b. 导航方法已弃用**
   ```dart
   // 旧方法（已弃用）
   appRouter.pushNamed('/auth/login');
   context.router.pushNamed('/path');
   
   // 新方法（推荐）
   appRouter.pushPath('/auth/login');
   context.router.pushPath('/path');
   ```

2. 建议运行完整的代码生成确保所有生成的文件正常：
   ```bash
   flutter pub run build_runner build --delete-conflicting-outputs
   ```

3. 如果代码中使用了 `pushNamed`，请全局替换为 `pushPath`

## 迁移步骤

### 1. 更新依赖版本（已完成）

- `auto_route`: 9.2.2 → 10.2.2
- `auto_route_generator`: 9.0.0 → 10.2.6

### 2. 添加必要的导入（已完成）

在 `app_router.dart` 中添加 Flutter material 导入：

```dart
import 'package:flutter/material.dart';
```

这是必需的，因为生成的路由文件使用了 `Key` 类型。

### 3. 重新生成路由文件（已完成）

```bash
dart run build_runner build --delete-conflicting-outputs
```

### 4. 更新 MaterialApp.router 配置（已完成）

```dart
// 从 routerConfig 改为 delegate 模式
MaterialApp.router(
  routerDelegate: appRouter.delegate(),
  routeInformationParser: appRouter.defaultRouteParser(),
  // ...
)
```

### 5. 替换已弃用的导航方法（已完成）

将所有 `pushNamed` 替换为 `pushPath`

### 6. 替换 GoRouterState（已完成）

```dart
// 旧方法（go_router）
final currentPath = GoRouterState.of(context).uri.path;
final currentPath = GoRouterState.of(context).uri.toString();

// 新方法（auto_route）
final currentPath = context.router.currentPath;
```

### 7. 修复路由名称（已完成）

```dart
// app_router.dart 中修正路由引用
AutoRoute(
  page: MyHomeRoute.page,  // 之前错误地写成 HomeRoute.page
  path: '',
),
```

### 8. 清理未使用的导入（已完成）

删除不再需要的 `package:flutter/scheduler.dart` 等导入

## 迁移结果

✅ 所有编译错误已修复  
✅ 依赖冲突已解决  
✅ 路由系统正常工作  
✅ 应用可以正常构建和运行  
✅ 仅剩少量 info/warning 级别的代码风格建议（无致命错误）

## 常见问题

### Q: 为什么会出现 "Type 'Key' not found" 错误？

**A:** 生成的 `app_router.gr.dart` 使用了 Flutter 的 `Key` 类型，但 `app_router.dart` 没有导入
`package:flutter/material.dart`。解决方法是在 `app_router.dart` 顶部添加该导入。

### Q: pushNamed 和 pushPath 有什么区别？

**A:** 在 auto_route 10.x 中，`pushNamed` 已被弃用，推荐使用 `pushPath`。功能相同，只是 API 名称更改。

### Q: 如何获取当前路由路径？

**A:** 使用 `context.router.currentPath` 替代 go_router 的 `GoRouterState.of(context).uri.path`。

## 相关文档

- [auto_route 迁移指南](https://pub.dev/packages/auto_route/changelog)
- [source_gen 版本历史](https://pub.dev/packages/source_gen/changelog)
- [auto_route 10.x 文档](https://pub.dev/packages/auto_route)

