# 用户钱包查看和充值功能实现

## 日期

2025年11月06日

## 变更概述

为 `user_v2` 页面新增了用户钱包信息查看卡片，并创建了一个新的充值页面，允许管理员为用户账户添加余额。

## 新增文件

### 1. UserMoneyCard Widget

**文件路径**: `/lib/pages/low_admin/widgets/user_money_card.dart`

**功能**:

- 展示用户钱包信息卡片
- 显示用户ID、账户余额、推荐返利和邀请人数
- 提供充值按钮，可跳转到充值页面

**主要字段**:

- `账户余额` (moneyAmount): 用户当前账户余额
- `推荐返利` (moneyAmountRef): 推荐返利金额
- `邀请人数` (inviteNum): 用户邀请的人数

### 2. UserMoneyRechargePage

**文件路径**: `/lib/pages/low_admin/user_money_recharge.dart`

**功能**:

- 为指定用户充值余额
- 支持输入充值金额（最多两位小数）
- 支持添加备注信息
- 可选择是否将充值记录显示在用户的充值历史中

**表单验证**:

- 充值金额必填且必须大于0
- 金额格式验证（支持两位小数）
- 备注可选，最多200字符

**API调用**:

```dart

final body = WebSubFastapiRoutersApiVLowAdminApiUserMoneyMoneyRechargeItParamsModel(
  moneyAmountAdd: amount,
  isInsertPaylist: _isInsertPaylist,
  remark: _remarkController.text
      .trim()
      .isEmpty
      ? null
      : _remarkController.text.trim(),
);

final response = await
_restClient.fallback
    .postUserMoneyMoneyRechargeItApiV2LowAdminApiUserMoneyMoneyRechargeItUserIdPost
(
userId: widget.userId,
body: body,
);
```

## 修改文件

### UserV2Page

**文件路径**: `/lib/pages/low_admin/user_v2.dart`

**变更内容**:

1. 新增 `_userMoneyData` 状态变量用于存储钱包数据
2. 在 `_loadUserData()` 中添加钱包数据的获取
3. 新增 `_navigateToRecharge()` 方法处理跳转到充值页面
4. 在页面中添加 `UserMoneyCard` 组件展示钱包信息

**数据获取**:

```dart

final results = await
Future.wait<dynamic>
([client.getUserV2ByUserIdApiV2LowAdminApiUserV2UserIdGet(
userId: widget.userId,
),
client.getUserOldServiceApiV2LowAdminApiUserOldServiceUserIdGet(
userId: widget.userId,
),
client.getUserV2ByUserIdApiV2LowAdminApiUserMoneyUserIdGet(
userId: widget.
userId
,
)
,
]
);
```

## API 端点

### 获取用户钱包信息

- **方法**: GET
- **路径**: `/api/v2/low_admin_api/user_money/{user_id}`
- **响应**: `GetUserMoneyResponse` 包含 `AdminUserMoneyModel`

### 用户充值

- **方法**: POST
- **路径**: `/api/v2/low_admin_api/user_money_money_recharge_it/{user_id}/`
- **参数**:
    - `moneyAmountAdd`: 充值金额（必填）
    - `isInsertPaylist`: 是否显示在充值记录（默认 true）
    - `remark`: 备注信息（可选）

## 数据模型

### AdminUserMoneyModel

```dart
class AdminUserMoneyModel {
  final int id; // 用户ID
  final String moneyAmount; // 账户余额
  final String moneyAmountRef; // 推荐返利
  final int inviteNum; // 邀请人数
}
```

## UI 特性

### UserMoneyCard

- 卡片式设计，与其他信息卡片风格统一
- 使用钱包图标标识
- 余额显示为绿色，推荐返利显示为蓝色
- 提供醒目的绿色充值按钮

### UserMoneyRechargePage

- 表单式输入界面
- 实时金额格式验证
- 多行备注输入框
- 开关控制是否记录到充值历史
- 全宽提交按钮，提交中显示加载动画
- 充值成功后自动返回并刷新数据

## 用户流程

1. 管理员进入用户详情页面（UserV2Page）
2. 页面加载时自动获取用户基本信息、服务信息和钱包信息
3. 查看钱包信息卡片，点击"充值"按钮
4. 跳转到充值页面，输入充值金额和备注
5. 选择是否记录到充值历史
6. 点击"确认充值"提交
7. 充值成功后返回用户详情页，自动刷新显示最新余额

## 技术要点

### 遵循编码规范

- 使用 API 模型类进行类型安全的数据传输
- 避免使用 try-catch 包装无意义的错误
- 代码精简，功能直接
- 使用 `Future.wait` 并发请求提高加载效率

### 状态管理

- 使用 `setState` 管理本地状态
- 充值成功后通过返回值触发父页面刷新

### 用户体验

- 表单验证提供即时反馈
- 提交按钮显示加载状态
- 使用 SnackBar 提供操作结果反馈
- 支持下拉刷新重新加载数据

## 测试建议

1. 测试充值金额的各种输入情况（整数、小数、负数、零等）
2. 测试备注字段的长度限制
3. 验证充值成功后余额是否正确更新
4. 测试充值记录开关的功能
5. 测试网络错误情况下的错误提示

## 相关文件

- `/lib/api/models/admin_user_money_model.dart` - 钱包数据模型
- `/lib/api/models/get_user_money_response.dart` - 获取钱包信息响应模型
- `/lib/api/models/web_sub_fastapi_routers_api_v_low_admin_api_user_money_money_recharge_it_params_model.dart` - 充值参数模型
- `/lib/api/fallback/fallback_client.dart` - API 客户端（自动生成）

