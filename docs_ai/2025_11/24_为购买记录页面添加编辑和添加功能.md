# 为购买记录页面添加编辑和添加功能

## 更新内容

为购买记录管理页面添加了完整的编辑功能，并提供添加功能的入口（API 暂不支持）。

## 功能说明

### 1. 编辑购买记录 ✅

用户可以直接在购买记录列表中点击"编辑"按钮，修改以下字段：

- **商品 ID** (shop_id)
- **金额** (money_amount)
- **创建时间** (created_at)

**注意：** 用户 ID (user_id) 在编辑模式下不可修改，以保证数据一致性。

### 2. 删除购买记录 ✅

已有的删除功能保持不变，用户可以删除购买记录（需要确认）。

### 3. 添加购买记录 ⚠️

提供了添加记录的入口（浮动按钮），但由于 API 暂不支持 POST 方法创建购买记录，目前会显示提示信息。

## 技术实现

### 1. 启用编辑功能

修改 `LowAdminUserBoughtListPage`，将 `BoughtRecordsListComponent` 的 `isShowActions` 参数设置为 `true`：

**修改前：**

```dart
BoughtRecordsListComponent
(
key: ValueKey(_queryString),
q: _queryString,
isShowActions
:
false
, // ❌ 不显示操作按钮
isEnableUserIdNavigation
:
true
,
)
```

**修改后：**

```dart
BoughtRecordsListComponent
(
key: ValueKey(_queryString),
q: _queryString,
isShowActions
:
true
, // ✅ 显示编辑和删除按钮
isEnableUserIdNavigation
:
true
,
)
```

### 2. 添加 Scaffold 包裹

为了支持浮动按钮，将页面内容包裹在 `Scaffold` 中：

```dart
@override
Widget build(BuildContext context) {
  return Scaffold(
    body: CustomScrollView(...),
    floatingActionButton: FloatingActionButton.extended(
      onPressed: _showAddRecordDialog,
      icon: const Icon(Icons.add),
      label: const Text('添加记录'),
    ),
  );
}
```

### 3. 添加记录对话框

创建了 `_showAddRecordDialog` 方法，用于显示添加记录的提示信息：

```dart
void _showAddRecordDialog() {
  // 从查询字符串中提取 user_id
  int? userId;
  if (_queryString != null && _queryString!.contains('user_id:')) {
    final match = RegExp(r'user_id:(\d+)').firstMatch(_queryString!);
    if (match != null) {
      userId = int.tryParse(match.group(1)!);
    }
  }

  showDialog(
    context: context,
    builder: (context) =>
        AlertDialog(
          title: const Text('添加购买记录'),
          content: Column(
            mainAxisSize: MainAxisSize.min,
            children: [
              const Icon(Icons.info_outline, size: 48, color: Colors.orange),
              const SizedBox(height: 16),
              const Text(
                'API 暂不支持添加购买记录功能',
                style: TextStyle(fontSize: 16),
                textAlign: TextAlign.center,
              ),
              if (userId != null)
                Padding(
                  padding: const EdgeInsets.only(top: 8),
                  child: Text(
                    '用户 ID: $userId',
                    style: TextStyle(fontSize: 14, color: Colors.grey[600]),
                  ),
                ),
            ],
          ),
          actions: [
            TextButton(
              onPressed: () => Navigator.pop(context),
              child: const Text('确定'),
            ),
          ],
        ),
  );
}
```

### 4. 创建独立的表单对话框组件（备用）

创建了 `BoughtRecordFormDialog` 组件（`lib/component/bought_records/bought_record_form_dialog.dart`），支持：

- 编辑模式和添加模式
- 表单验证
- 日期时间选择器
- API 调用和错误处理

**注意：** 目前 `BoughtRecordsListComponent` 使用的是自己内部的 `_EditBoughtRecordDialog`，这个独立组件可以在未来需要时使用。

## 编辑功能详情

### 可编辑字段

| 字段名   | 类型            | 是否必填 | 说明               |
|-------|---------------|------|------------------|
| 商品 ID | int           | ✅    | 购买的商品ID          |
| 金额    | string/number | ✅    | 购买金额，例如: "10.00" |
| 创建时间  | DateTime      | ✅    | 购买时间（UTC）        |

### 不可编辑字段

| 字段名   | 说明               |
|-------|------------------|
| 记录 ID | 购买记录的唯一标识        |
| 用户 ID | 购买用户的ID（编辑时不可修改） |
| 商品名称  | 仅用于显示，从商品ID自动获取  |
| 过期时间  | 由系统管理            |

## API 接口

### 更新购买记录

```
PUT /api/v2/low_admin_api/user_bought/{bought_id}
```

**请求参数：**

```dart
WebSubFastapiRoutersApiVLowAdminApiUserBoughtPutParamsModel {shopId: int,createdAt: DateTime, // UTC 时间
moneyAmount: dynamic,}
```

**响应：**

```dart
ErrorResponse {isSuccess: bool,message: string,}
```

### 删除购买记录

```
DELETE /api/v2/low_admin_api/user_bought/{bought_id}
```

## 使用流程

### 编辑购买记录

1. 在购买记录列表中找到要编辑的记录
2. 点击记录卡片右上角的"编辑"按钮（铅笔图标）
3. 在弹出的对话框中修改字段
4. 点击"更新"按钮保存更改
5. 系统会显示操作结果并自动刷新列表

### 删除购买记录

1. 在购买记录列表中找到要删除的记录
2. 点击记录卡片右上角的"删除"按钮（垃圾桶图标）
3. 在确认对话框中点击"删除"
4. 系统会显示操作结果并自动刷新列表

### 添加购买记录

1. 点击页面右下角的"添加记录"浮动按钮
2. 查看提示信息（API 暂不支持）

## 时间处理规范

遵循项目的时间处理规范：

- ✅ 从 API 获取的时间自动解析为 DateTime（UTC）
- ✅ 编辑对话框中显示本地时间 `.toLocal()`
- ✅ 提交到 API 时转换为 UTC 时间 `.toUtc()`
- ✅ 使用 `DateFormat` 格式化显示时间

## 相关文件

- `/lib/page/low_admin/user_bought_list/low_admin_user_bought_list_page.dart` - 购买记录列表页面
- `/lib/component/bought_records/bought_records_list_component.dart` - 购���记录列表组件（包含编辑对话框）
- `/lib/component/bought_records/bought_record_form_dialog.dart` - 独立的表单对话框组件（备用）
- `/lib/api/models/web_sub_fastapi_routers_api_v_low_admin_api_user_bought_put_params_model.dart` - 更新参数模型
-
`/lib/api/models/web_sub_fastapi_routers_api_v_low_admin_api_user_bought_get_user_bought_response_result_list_data.dart` -
购买记录数据模型

## 注意事项

1. ✅ 编辑购买记录时，用户 ID 不可修改
2. ✅ 金额字段支持小数，建议使用标准货币格式（如 "10.00"）
3. ✅ 创建时间使用日期时间选择器，自动处理 UTC 转换
4. ✅ 所有操作都有错误处理和用户反馈
5. ⚠️ 添加功能需要等待 API 支持 POST 方法
6. ✅ 编辑和删除操作会自动刷新列表

## 未来改进

当 API 支持 POST 方法创建购买记录时，可以：

1. 在 `fallback_client.dart` 中添加相应的方法定义
2. 修改 `_showAddRecordDialog` 使用真实的表单对话框
3. 可以使用已创建的 `BoughtRecordFormDialog` 组件
4. 从查询字符串中提取用户 ID 作为默认值

## 测试建议

1. 测试编辑功能：
    - 修改商品 ID
    - 修改金额
    - 修改创建时间
    - 验证用户 ID 不可修改
    - 验证表单验证规则

2. 测试删除功能：
    - 删除记录
    - 取消删除
    - 验证确认对话框

3. 测试添加功能：
    - 点击添加按钮
    - 验证提示信息
    - 验证用户 ID 自动提取

4. 测试查询功能：
    - 按用户 ID 查询
    - 编辑/删除后列表自动刷新

