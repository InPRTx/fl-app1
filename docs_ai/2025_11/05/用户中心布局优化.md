# 用户中心布局优化

## 修改日期

2025年11月5日

## 修改内容

### 概述

将用户中心（/user）的菜单栏和页面布局改造成与 `/low_admin` 相同的样式，在中大屏幕设备上直接显示左侧导航栏，提升用户体验。

### 具体修改

#### 1. 修改 `UserLayout` 组件

**文件路径**: `/lib/widgets/user_layout.dart`

**主要变更**:

- 添加 `LayoutBuilder` 来检测屏幕尺寸
- 在宽度 >= 768px 的大屏幕上显示 `UserNavigationRail`
- 在小屏幕上继续使用原有的 `Drawer`
- 大屏幕时不显示 hamburger 菜单图标
- 使用 `Row` 布局将导航栏和内容区域并排显示

**关键代码**:

```dart
return LayoutBuilder(
builder: (context, constraints) {
final isLargeScreen = constraints.maxWidth >= 768;

return Scaffold(
appBar: AppBar(
// ...
leading: isLargeScreen ? null : Builder(
builder: (context) => IconButton(
icon: const Icon(Icons.menu),
onPressed: () {
Scaffold.of(context).openDrawer();
},
),
),
),
drawer: isLargeScreen ? null : const UserSidebar(),
body: Row(
children: [
if (isLargeScreen) const UserNavigationRail(),
Expanded(child: child),
],
),
);
},
);
```

#### 2. 新增 `UserNavigationRail` 组件

**文件路径**: `/lib/widgets/user_sidebar.dart`

**主要功能**:

- 创建固定宽度（280px）的左侧导航栏
- 显示用户中心图标和标题
- 使用可滚动列表显示所有导航项
- 支持展开/收起子菜单（使用 `ExpansionTile`）
- 根据当前路径高亮选中项
- 添加滚动条以支持长列表

**特点**:

- 支持嵌套菜单结构
- 自动展开包含当前页面的父菜单
- 使用主题色彩突出选中状态
- 子菜单项有缩进显示

**关键实现**:

```dart
class UserNavigationRail extends StatefulWidget {
  const UserNavigationRail({super.key});

  @override
  State<UserNavigationRail> createState() => _UserNavigationRailState();
}

class _UserNavigationRailState extends State<UserNavigationRail> {
  // 使用 ScrollController 管理滚动
  final ScrollController _scrollController = ScrollController();
  
  // 获取主要导航项（过滤掉header）
  List<SidebarItemMenu> get _mainNavItems {
    return sidebarItemLogin.where((item) => item.header == null).toList();
  }
  
  // 构建导航栏UI，包含header和可滚动的菜单列表
  // ...
}
```

### 布局特性

#### 响应式断点

- **小屏幕**（宽度 < 768px）: 使用传统的 Drawer 抽屉式菜单
- **中大屏幕**（宽度 >= 768px）: 显示固定的左侧导航栏

#### 导航栏样式

- 固定宽度: 280px
- 包含header区域显示用户中心图标和标题
- 菜单项支持图标、文字和选中状态
- 子菜单使用 `ExpansionTile` 实现展开收起
- 添加右侧边框分隔内容区域

#### 用户体验优化

1. **大屏幕设备**: 导航栏始终可见，无需点击菜单按钮
2. **小屏幕设备**: 保持原有抽屉式菜单，节省屏幕空间
3. **路径高亮**: 自动高亮当前页面对应的菜单项
4. **自动展开**: 自动展开包含当前页面的父菜单
5. **流畅交互**: 点击菜单项直接跳转，无需关闭导航栏

### 与 low_admin 的一致性

此次修改完全遵循了 `/low_admin` 的布局模式:

- 使用相同的响应式断点（768px）
- 类似的 LayoutBuilder 结构
- 一致的大屏/小屏切换逻辑
- 统一的导航栏展示方式

### 影响范围

所有使用 `UserLayout` 的页面都将自动应用新布局，包括但不限于:

- 用户主页（/user/dashboard）
- 我的服务
- 财务管理
- 技术支持
- 服务使用
- 我的账户
- 等所有用户中心页面

### 技术细节

#### 代码精简

- 移除了未使用的 `selectedIndex` 变量
- 移除了未使用的 `go_router` 导入

#### 主题适配

- 使用 `theme.colorScheme` 确保与应用主题一致
- 选中状态使用 `primaryContainer` 和 `primary` 颜色
- 支持 Material Design 3 的色彩系统

#### 性能优化

- 使用 `Scrollbar` 和 `thumbVisibility` 提供更好的滚动体验
- `ExpansionTile` 的 `initiallyExpanded` 仅在需要时展开

## 测试建议

1. 在不同屏幕尺寸下测试布局切换
2. 验证所有菜单项的跳转功能
3. 检查子菜单的展开收起交互
4. 确认当前路径的高亮显示正确
5. 测试滚动条在长菜单列表下的表现

## 第二次优化 - NavigationRail 样式统一

### 修改内容

#### 1. 将 UserNavigationRail 改为标准 NavigationRail

之前使用的是自定义宽度（280px）的侧边栏，现在改为使用 Flutter 标准的 `NavigationRail` 组件，完全与 `/low_admin` 保持一致。

**主要变更**:

- 移除自定义的宽侧边栏布局
- 使用标准 `NavigationRail` 组件（自适应宽度，约 72-80px）
- 配置 `labelType: NavigationRailLabelType.all` 显示所有标签
- 添加顶部图标 leading
- 添加底部返回主页按钮 trailing

**精简的导航项配置**:

```dart
final List<UserNavigationItem> userNavItems = [
  UserNavigationItem(icon: Icons.dashboard, label: '主页', route: '/user/dashboard'),
  UserNavigationItem(icon: Icons.shopping_bag_outlined, label: '产品服务', route: '/user/services/'),
  UserNavigationItem(icon: Icons.attach_money, label: '财务管理', route: '/user/wallet/billing'),
  UserNavigationItem(icon: Icons.support_agent_outlined, label: '技术支持', route: '/user/tickets'),
  UserNavigationItem(icon: Icons.cloud_upload_outlined, label: '服务使用', route: '/user/subscribe-log'),
  UserNavigationItem(icon: Icons.person_outline, label: '我的账户', route: '/user/my-account'),
  UserNavigationItem(icon: Icons.share_outlined, label: '用户推广', route: '/user/promote'),
  UserNavigationItem(icon: Icons.settings_outlined, label: '设置', route: '/settings'),
];
```

#### 2. 统一主题色彩

**AppBar 颜色统一**:

- 将 `backgroundColor` 从 `primary` 改为 `inversePrimary`
- 移除 `foregroundColor` 配置，使用默认主题色
- 与 `/low_admin` 保持完全一致的视觉风格

**UserSidebar Drawer 样式统一**:

- DrawerHeader 背景色从 `primaryContainer` 改为 `primary`
- 文字颜色从 `onPrimaryContainer` 改为 `onPrimary`
- 图标大小从 64 改为 48，与 low_admin 一致
- 使用直接的 TextStyle 而非 theme.textTheme

#### 3. 添加返回主页功能

在 NavigationRail 和 Drawer 中都添加了返回主页按钮：

**NavigationRail**:

```dart
trailing: Expanded
(
child: Align(
alignment: Alignment.bottomCenter,
child: Padding(
padding: const EdgeInsets.only(bottom: 16),
child: IconButton(
icon: const Icon(Icons.home),
tooltip: '返回主页',
onPressed: () => context.go('/'),
),
)
,
)
,
)
,
```

**Drawer**:

```dart
const Divider
(),ListTile
(
leading: const Icon(Icons.home),
title: const Text('返回主页'),
onTap: () {
Navigator.pop(context);
context.go('/');
},
)
,
```

### 视觉效果对比

#### 之前（自定义宽侧边栏）

- 固定宽度 280px
- 使用 ExpansionTile 显示所有子菜单
- 占用较多横向空间
- 完整的菜单层级结构

#### 现在（标准 NavigationRail）

- 自适应宽度约 72-80px
- 仅显示主要导航项
- 节省横向空间
- 简洁的顶级菜单
- 与 `/low_admin` 完全一致

### 优势

1. **空间利用**: NavigationRail 比宽侧边栏节省约 200px 的横向空间
2. **视觉统一**: 与 `/low_admin` 使用完全相同的布局和主题
3. **简洁明了**: 主要功能一目了然，减少视觉干扰
4. **标准组件**: 使用 Flutter 标准组件，更好的兼容性和性能

### 导航逻辑

**路径匹配优先级**:

1. 完全匹配：优先查找与当前路径完全相同的导航项
2. 前缀匹配：如果没有完全匹配，则查找路径前缀匹配的导航项（用于高亮子页面所属的父菜单）
3. 默认选中：如果都不匹配，默认选中第一项

**示例**:

- 访问 `/user/dashboard` → 选中"主页"
- 访问 `/user/services/renewals/` → 选中"产品服务"（前缀匹配）
- 访问 `/user/wallet/billing` → 选中"财务管理"

## 后续优化建议

1. 可以考虑将断点值（768px）提取为常量，便于统一管理
2. 可以在 NavigationRail 选中项时添加过渡动画
3. 考虑为每个导航项添加徽章（badge）显示未读消息数
4. 可以添加菜单项的快捷键支持

