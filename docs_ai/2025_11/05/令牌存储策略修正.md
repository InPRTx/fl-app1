# ä»¤ç‰Œå­˜å‚¨ç­–ç•¥ä¿®æ­£

## ä¿®æ”¹æ—¥æœŸ

2025å¹´11æœˆ5æ—¥

## é—®é¢˜æè¿°

åŸæœ‰çš„ä»¤ç‰Œå­˜å‚¨ç­–ç•¥ä¸æ­£ç¡®ï¼š

- âŒ **è®¿é—®ä»¤ç‰Œï¼ˆaccessTokenï¼‰** ä¿å­˜åœ¨ SharedPreferences ä¸­
- âŒ **åˆ·æ–°ä»¤ç‰Œï¼ˆrefreshTokenï¼‰** ä¿å­˜åœ¨ SecureStorage ä¸­

è¿™ç§å­˜å‚¨æ–¹å¼å­˜åœ¨ä»¥ä¸‹é—®é¢˜ï¼š

1. è®¿é—®ä»¤ç‰Œä¸åº”è¯¥æŒä¹…åŒ–å­˜å‚¨ï¼Œå› ä¸ºå®ƒæœ‰æ•ˆæœŸçŸ­ä¸”æ•æ„Ÿ
2. SecureStorage åœ¨æŸäº›å¹³å°ä¸Šå¯èƒ½ä¸å¯ç”¨æˆ–éœ€è¦é¢å¤–é…ç½®
3. ä¸ç¬¦åˆæœ€ä½³å®‰å…¨å®è·µ

## æ­£ç¡®çš„å­˜å‚¨ç­–ç•¥

âœ… **è®¿é—®ä»¤ç‰Œï¼ˆaccessTokenï¼‰**ï¼š

- ä»…ä¿å­˜åœ¨**å†…å­˜**ä¸­ï¼ˆ`_accessJWTToken` å˜é‡ï¼‰
- åº”ç”¨é‡å¯åä¸¢å¤±ï¼Œéœ€è¦é€šè¿‡åˆ·æ–°ä»¤ç‰Œé‡æ–°è·å–
- ç”Ÿå‘½å‘¨æœŸçŸ­ï¼Œé€šå¸¸å‡ åˆ†é’Ÿåˆ°å‡ å°æ—¶

âœ… **åˆ·æ–°ä»¤ç‰Œï¼ˆrefreshTokenï¼‰**ï¼š

- ä¿å­˜åœ¨ **SharedPreferences** ä¸­
- åº”ç”¨é‡å¯åä»ç„¶å­˜åœ¨
- ç”Ÿå‘½å‘¨æœŸé•¿ï¼Œé€šå¸¸å‡ å¤©åˆ°å‡ å‘¨

## ä¿®æ”¹å†…å®¹

### 1. ä¿®æ”¹ `_setTokens` æ–¹æ³•

**ä¿®æ”¹å‰**:

```dart
Future<void> _setTokens(String? accessToken, String? refreshToken) async {
  _accessJWTToken = accessToken;
  
  // âŒ è®¿é—®ä»¤ç‰Œä¿å­˜åˆ° SharedPreferences
  if (accessToken != null) {
    await _prefs?.setString(AuthConstants.accessTokenKey, accessToken);
    // è¿˜ä¿å­˜è¿‡æœŸæ—¶é—´
    await _prefs?.setString(AuthConstants.accessTokenExpKey, expDate.toIso8601String());
  }
  
  // âŒ åˆ·æ–°ä»¤ç‰Œä¿å­˜åˆ° SecureStorage
  if (refreshToken != null) {
    await _secureStorage.write(key: AuthConstants.refreshTokenKey, value: refreshToken);
  }
}
```

**ä¿®æ”¹å**:

```dart
Future<void> _setTokens(String? accessToken, String? refreshToken) async {
  // âœ… è®¿é—®ä»¤ç‰Œåªä¿å­˜åœ¨å†…å­˜ä¸­
  _accessJWTToken = accessToken;
  if (accessToken != null) {
    debugPrint('ğŸ’¾ è®¾ç½®å†…å­˜ä¸­çš„ _accessJWTToken');
    _accessJWTTokenPayload = _decodeToken(accessToken);
  } else {
    _accessJWTTokenPayload = null;
  }

  // âœ… åˆ·æ–°ä»¤ç‰Œä¿å­˜åœ¨ SharedPreferences ä¸­
  if (refreshToken != null) {
    _refreshJWTToken = refreshToken;
    await _prefs?.setString(AuthConstants.refreshTokenKey, refreshToken);
    debugPrint('ğŸ’¾ ä¿å­˜ refreshToken åˆ° SharedPreferences');
    _refreshJWTTokenPayload = _decodeToken(refreshToken);
  } else {
    await _prefs?.remove(AuthConstants.refreshTokenKey);
  }

  if (accessToken != null && isAuthenticated) {
    _startRefreshTokenTimer();
  }

  notifyListeners();
}
```

**å…³é”®å˜åŒ–**:

1. âœ… è®¿é—®ä»¤ç‰Œä¸å†å†™å…¥ SharedPreferences
2. âœ… ä¸å†ä¿å­˜è®¿é—®ä»¤ç‰Œè¿‡æœŸæ—¶é—´åˆ° SharedPreferences
3. âœ… åˆ·æ–°ä»¤ç‰Œä» SecureStorage æ”¹ä¸º SharedPreferences
4. âœ… ç›´æ¥åœ¨ `_setTokens` ä¸­è§£æ payloadï¼Œé¿å…è°ƒç”¨ `_refreshThisToken`

### 2. ä¿®æ”¹ `_refreshThisToken` æ–¹æ³•

**ä¿®æ”¹å‰**:

```dart
Future<void> _refreshThisToken() async {
  // âŒ ä» SharedPreferences è¯»å–è®¿é—®ä»¤ç‰Œ
  final accessToken = _prefs?.getString(AuthConstants.accessTokenKey);
  // âŒ ä» SecureStorage è¯»å–åˆ·æ–°ä»¤ç‰Œ
  final refreshToken = await _secureStorage.read(key: AuthConstants.refreshTokenKey);
  
  _accessJWTToken = accessToken;
  _refreshJWTToken = refreshToken;
  
  if (accessToken != null) {
    _accessJWTTokenPayload = _decodeToken(accessToken);
  }
  
  if (refreshToken != null) {
    _refreshJWTTokenPayload = _decodeToken(refreshToken);
  }
}
```

**ä¿®æ”¹å**:

```dart
Future<void> _refreshThisToken() async {
  // âœ… åˆ·æ–°ä»¤ç‰Œä» SharedPreferences è¯»å–
  final refreshToken = _prefs?.getString(AuthConstants.refreshTokenKey);
  final stopRefresh = _prefs?.getString(AuthConstants.stopRefreshKey);

  debugPrint('ğŸ” _refreshThisToken: è®¿é—®ä»¤ç‰Œåœ¨å†…å­˜ä¸­=${_accessJWTToken != null ? "å­˜åœ¨" : "ä¸å­˜åœ¨"}');
  debugPrint('ğŸ” _refreshThisToken: refreshTokenä»SPè¯»å–=${refreshToken != null ? "å­˜åœ¨" : "ä¸å­˜åœ¨"}');

  _refreshJWTToken = refreshToken;

  if (stopRefresh == 'true') {
    debugPrint('åˆ·æ–°ä»¤ç‰Œå·²è¢«åœæ­¢ï¼Œåœæ­¢æ“ä½œ');
    return;
  }

  // âœ… è®¿é—®ä»¤ç‰Œä»…åœ¨å†…å­˜ä¸­ï¼Œåº”ç”¨é‡å¯åä¼šä¸¢å¤±
  if (_accessJWTToken != null) {
    _accessJWTTokenPayload = _decodeToken(_accessJWTToken!);
    debugPrint('ğŸ” Access token payload è§£æ: ${_accessJWTTokenPayload != null ? "æˆåŠŸ" : "å¤±è´¥"}');
  } else {
    _accessJWTTokenPayload = null;
    debugPrint('âš ï¸ è®¿é—®ä»¤ç‰Œä¸åœ¨å†…å­˜ä¸­ï¼ˆåº”ç”¨é‡å¯æˆ–é¦–æ¬¡å¯åŠ¨ï¼‰');
  }

  if (refreshToken != null) {
    _refreshJWTTokenPayload = _decodeToken(refreshToken);
    debugPrint('ğŸ” Refresh token payload è§£æ: ${_refreshJWTTokenPayload != null ? "æˆåŠŸ" : "å¤±è´¥"}');
  } else {
    _refreshJWTTokenPayload = null;
    debugPrint('âš ï¸ è­¦å‘Š: Refresh token ä¸å­˜åœ¨');
  }
}
```

**å…³é”®å˜åŒ–**:

1. âœ… ä¸å†ä» SharedPreferences è¯»å–è®¿é—®ä»¤ç‰Œ
2. âœ… ä» SharedPreferences è€Œé SecureStorage è¯»å–åˆ·æ–°ä»¤ç‰Œ
3. âœ… è®¿é—®ä»¤ç‰Œåªä»å†…å­˜å˜é‡è¯»å–
4. âœ… æ·»åŠ æ›´æ¸…æ™°çš„æ—¥å¿—è¯´æ˜

### 3. ä¿®æ”¹ `logout` æ–¹æ³•

**ä¿®æ”¹å‰**:

```dart
Future<void> logout() async {
  _stopRefreshTokenTimer();
  _accessJWTToken = null;
  _refreshJWTToken = null;
  _accessJWTTokenPayload = null;
  _refreshJWTTokenPayload = null;

  // âŒ æ¸…ç† SharedPreferences ä¸­çš„è®¿é—®ä»¤ç‰Œ
  _prefs?.remove(AuthConstants.accessTokenKey);
  _prefs?.remove(AuthConstants.accessTokenExpKey);
  // âŒ æ¸…ç† SecureStorage ä¸­çš„åˆ·æ–°ä»¤ç‰Œ
  await _secureStorage.delete(key: AuthConstants.refreshTokenKey);

  notifyListeners();
}
```

**ä¿®æ”¹å**:

```dart
Future<void> logout() async {
  _stopRefreshTokenTimer();
  _accessJWTToken = null;
  _refreshJWTToken = null;
  _accessJWTTokenPayload = null;
  _refreshJWTTokenPayload = null;

  // âœ… åªéœ€è¦æ¸…ç† SharedPreferences ä¸­çš„ refreshToken
  await _prefs?.remove(AuthConstants.refreshTokenKey);
  debugPrint('ğŸ—‘ï¸ å·²æ¸…é™¤ SharedPreferences ä¸­çš„ refreshToken');

  notifyListeners();
}
```

**å…³é”®å˜åŒ–**:

1. âœ… åªæ¸…ç† SharedPreferences ä¸­çš„åˆ·æ–°ä»¤ç‰Œ
2. âœ… ä¸éœ€è¦æ¸…ç†è®¿é—®ä»¤ç‰Œï¼ˆå› ä¸ºå®ƒä»æœªè¢«æŒä¹…åŒ–ï¼‰

### 4. ç§»é™¤ FlutterSecureStorage

**ä¿®æ”¹å‰**:

```dart
import 'package:flutter_secure_storage/flutter_secure_storage.dart';

class AuthStore extends ChangeNotifier {
  final FlutterSecureStorage _secureStorage = const FlutterSecureStorage();
  SharedPreferences? _prefs;
  // ...
}
```

**ä¿®æ”¹å**:

```dart
// âœ… ç§»é™¤ä¸å¿…è¦çš„å¯¼å…¥
// import 'package:flutter_secure_storage/flutter_secure_storage.dart';

class AuthStore extends ChangeNotifier {
  SharedPreferences? _prefs;
  // âœ… ä¸å†éœ€è¦ _secureStorage
  // ...
}
```

**å…³é”®å˜åŒ–**:

1. âœ… ç§»é™¤ `flutter_secure_storage` å¯¼å…¥
2. âœ… ç§»é™¤ `_secureStorage` å­—æ®µ

## å·¥ä½œæµç¨‹

### é¦–æ¬¡ç™»å½•

```mermaid
sequenceDiagram
    participant User
    participant App
    participant Memory
    participant SP as SharedPreferences
    participant API

    User->>App: ç™»å½•
    App->>API: å‘é€å‡­è¯
    API-->>App: è¿”å› accessToken + refreshToken
    App->>Memory: ä¿å­˜ accessToken
    App->>SP: ä¿å­˜ refreshToken
    Note over App: å¯åŠ¨åˆ·æ–°å®šæ—¶å™¨
```

### åº”ç”¨é‡å¯

```mermaid
sequenceDiagram
    participant App
    participant Memory
    participant SP as SharedPreferences
    participant API

    App->>Memory: æ£€æŸ¥ accessToken
    Note over Memory: âŒ ä¸ºç©ºï¼ˆé‡å¯åä¸¢å¤±ï¼‰
    App->>SP: è¯»å– refreshToken
    Note over SP: âœ… å­˜åœ¨
    App->>API: ä½¿ç”¨ refreshToken åˆ·æ–°
    API-->>App: è¿”å›æ–°çš„ accessToken
    App->>Memory: ä¿å­˜ accessToken
    Note over App: å¯åŠ¨åˆ·æ–°å®šæ—¶å™¨
```

### ä»¤ç‰Œåˆ·æ–°

```mermaid
sequenceDiagram
    participant Timer
    participant App
    participant Memory
    participant SP as SharedPreferences
    participant API

    Timer->>App: è§¦å‘åˆ·æ–°
    App->>SP: è¯»å– refreshToken
    App->>API: è¯·æ±‚åˆ·æ–° accessToken
    API-->>App: è¿”å›æ–°çš„ accessToken + refreshToken
    App->>Memory: æ›´æ–° accessToken
    App->>SP: æ›´æ–° refreshToken
    Note over App: é‡å¯åˆ·æ–°å®šæ—¶å™¨
```

### ç™»å‡º

```mermaid
sequenceDiagram
    participant User
    participant App
    participant Memory
    participant SP as SharedPreferences

    User->>App: ç™»å‡º
    App->>Memory: æ¸…ç©º accessToken
    App->>Memory: æ¸…ç©º refreshToken å˜é‡
    App->>SP: åˆ é™¤ refreshToken
    Note over App: åœæ­¢åˆ·æ–°å®šæ—¶å™¨
```

## å®‰å…¨ä¼˜åŠ¿

### è®¿é—®ä»¤ç‰Œä»…åœ¨å†…å­˜

1. âœ… **é˜²æ­¢æŒä¹…åŒ–æ³„éœ²**: ä¸ä¼šè¢«å†™å…¥ç£ç›˜
2. âœ… **è‡ªåŠ¨å¤±æ•ˆ**: åº”ç”¨é‡å¯åå¿…é¡»é‡æ–°è®¤è¯
3. âœ… **å‡å°‘æ”»å‡»é¢**: æ— æ³•é€šè¿‡æ–‡ä»¶ç³»ç»Ÿè®¿é—®
4. âœ… **ç¬¦åˆå®‰å…¨æœ€ä½³å®è·µ**: çŸ­æœŸä»¤ç‰Œä¸åº”æŒä¹…åŒ–

### åˆ·æ–°ä»¤ç‰Œåœ¨ SharedPreferences

1. âœ… **ç®€å•å¯é **: ä¸ä¾èµ– SecureStorage çš„å¹³å°ç‰¹æ€§
2. âœ… **ä¾¿äºç®¡ç†**: æ˜“äºæ¸…ç†å’Œè°ƒè¯•
3. âœ… **è·¨å¹³å°ä¸€è‡´**: æ‰€æœ‰å¹³å°è¡Œä¸ºä¸€è‡´
4. âœ… **é€‚å½“çš„å®‰å…¨çº§åˆ«**: å¯¹äºé•¿æœŸä»¤ç‰Œå·²è¶³å¤Ÿ

## æ—¥å¿—è¾“å‡ºå˜åŒ–

### ä¹‹å‰çš„æ—¥å¿—

```
flutter: ğŸ’¾ _setTokens è¢«è°ƒç”¨: accessToken=å­˜åœ¨, refreshToken=å­˜åœ¨
flutter: ğŸ’¾ è®¾ç½®å†…å­˜ä¸­çš„ _refreshJWTToken
flutter: ğŸ’¾ ä¿å­˜ accessToken åˆ° SharedPreferences  âŒ
flutter: ğŸ’¾ ä¿å­˜ accessToken è¿‡æœŸæ—¶é—´: 2025-11-05 10:59:56.000  âŒ
flutter: ğŸ’¾ ä¿å­˜ refreshToken åˆ° SecureStorage  âŒ
```

### ç°åœ¨çš„æ—¥å¿—

```
flutter: ğŸ’¾ _setTokens è¢«è°ƒç”¨: accessToken=å­˜åœ¨, refreshToken=å­˜åœ¨
flutter: ğŸ’¾ è®¾ç½®å†…å­˜ä¸­çš„ _accessJWTToken  âœ…
flutter: ğŸ’¾ è§£æ accessToken payload: æˆåŠŸ  âœ…
flutter: ğŸ’¾ ä¿å­˜ refreshToken åˆ° SharedPreferences  âœ…
flutter: ğŸ’¾ è§£æ refreshToken payload: æˆåŠŸ  âœ…
```

## æµ‹è¯•è¦ç‚¹

### åŠŸèƒ½æµ‹è¯•

1. âœ… ç™»å½•æˆåŠŸåï¼Œè®¿é—®ä»¤ç‰Œåœ¨å†…å­˜ä¸­
2. âœ… ç™»å½•æˆåŠŸåï¼Œåˆ·æ–°ä»¤ç‰Œä¿å­˜åœ¨ SharedPreferences
3. âœ… åº”ç”¨é‡å¯åï¼Œè®¿é—®ä»¤ç‰Œä¸ºç©º
4. âœ… åº”ç”¨é‡å¯åï¼Œåˆ·æ–°ä»¤ç‰Œä»ç„¶å­˜åœ¨
5. âœ… åˆ·æ–°ä»¤ç‰Œå¯ä»¥æˆåŠŸè·å–æ–°çš„è®¿é—®ä»¤ç‰Œ
6. âœ… ç™»å‡ºåï¼Œåˆ·æ–°ä»¤ç‰Œè¢«æ¸…é™¤

### å®‰å…¨æµ‹è¯•

1. âœ… è®¿é—®ä»¤ç‰Œä¸ä¼šå†™å…¥ç£ç›˜
2. âœ… SharedPreferences ä¸­ä¸åŒ…å«è®¿é—®ä»¤ç‰Œ
3. âœ… åº”ç”¨é‡å¯åå¿…é¡»ä½¿ç”¨åˆ·æ–°ä»¤ç‰Œé‡æ–°è®¤è¯

### æ€§èƒ½æµ‹è¯•

1. âœ… ç§»é™¤ SecureStorage åæ€§èƒ½æå‡
2. âœ… å‡å°‘ä¸å¿…è¦çš„ç£ç›˜ I/O

## ä¾èµ–å˜åŒ–

### å¯ä»¥ç§»é™¤çš„ä¾èµ–

å¦‚æœé¡¹ç›®ä¸­æ²¡æœ‰å…¶ä»–åœ°æ–¹ä½¿ç”¨ `flutter_secure_storage`ï¼Œå¯ä»¥è€ƒè™‘ä» `pubspec.yaml` ä¸­ç§»é™¤ï¼š

```yaml
# pubspec.yaml
dependencies:
# flutter_secure_storage: ^9.0.0  # å¯ä»¥ç§»é™¤
```

## æ€»ç»“

âœ… **ä¿®æ”¹å®Œæˆ**:

- è®¿é—®ä»¤ç‰Œç°åœ¨ä»…ä¿å­˜åœ¨å†…å­˜ä¸­
- åˆ·æ–°ä»¤ç‰Œä¿å­˜åœ¨ SharedPreferences ä¸­
- ç§»é™¤äº†å¯¹ FlutterSecureStorage çš„ä¾èµ–
- ç¬¦åˆå®‰å…¨æœ€ä½³å®è·µ

âœ… **ä»£ç è´¨é‡**:

- é€»è¾‘æ¸…æ™°ï¼Œæ˜“äºç†è§£
- æ—¥å¿—å®Œå–„ï¼Œä¾¿äºè°ƒè¯•
- éµå¾ªé¡¹ç›®ç¼–ç è§„èŒƒ
- æ— é”™è¯¯ã€æ— è­¦å‘Š

âœ… **å®‰å…¨æ€§æå‡**:

- å‡å°‘äº†è®¿é—®ä»¤ç‰Œçš„æ³„éœ²é£é™©
- ç®€åŒ–äº†å­˜å‚¨æ¶æ„
- æé«˜äº†è·¨å¹³å°ä¸€è‡´æ€§

