# 优化部署工作流 - 动态分支推送

## 需求

修改 GitHub Actions 部署工作流，使其根据触发的源分支名称，自动推送到目标仓库的同名分支。

## 修改内容

### 修改文件：`.github/workflows/deploy-web.yml`

**修改前：**

```yaml
- name: Commit and push
  run: |
    cd target-repo
    git add .
    git diff --staged --quiet || git commit -m "Deploy from branch ${{ github.ref_name }} - commit ${{ github.sha }}"
    git push origin main || git push origin master
```

**修改后：**

```yaml
- name: Commit and push
  run: |
    cd target-repo
    # 切换到与源仓库同名的分支（如果不存在则创建）
    git checkout -B ${{ github.ref_name }}
    git add .
    git diff --staged --quiet || git commit -m "Deploy from branch ${{ github.ref_name }} - commit ${{ github.sha }}"
    git push -f origin ${{ github.ref_name }}
```

## 关键改进

### 1. 动态分支切换

```bash
git checkout -B ${{ github.ref_name }}
```

- `${{ github.ref_name }}` - GitHub Actions 提供的当前分支名称变量
- `-B` 参数 - 强制创建或切换分支
    - 如果分支已存在，切换到该分支
    - 如果分支不存在，创建新分支

### 2. 动态分支推送

```bash
git push -f origin ${{ github.ref_name }}
```

- 推送到与源分支同名的目标分支
- `-f` 强制推送 - 因为构建产物每次都是全新生成的

## 工作流程示例

### 场景 1：从 main 分支部署

```
源仓库: InPRTx/fl-app1 (main)
   ↓ 触发 workflow
   ↓ 构建 Web 应用
   ↓ 推送到
目标仓库: MaoMoLab/fl-app1-web (main)
```

### 场景 2：从 dev 分支部署

```
源仓库: InPRTx/fl-app1 (dev)
   ↓ 触发 workflow
   ↓ 构建 Web 应用
   ↓ 推送到
目标仓库: MaoMoLab/fl-app1-web (dev)
```

### 场景 3：从 new-featrue 分支部署

```
源仓库: InPRTx/fl-app1 (new-featrue)
   ↓ 触发 workflow
   ↓ 构建 Web 应用
   ↓ 推送到
目标仓库: MaoMoLab/fl-app1-web (new-featrue)
```

## 触发方式

### 自动触发

```yaml
on:
  push:
    branches:
      - main
```

推送到 `main` 分支时自动触发

### 手动触发

```yaml
on:
  workflow_dispatch:
```

可以在 GitHub Actions 页面手动触发，选择任意分支

## 优势

1. **多环境部署** - 不同分支可以部署到不同环境
    - `main` → 生产环境
    - `dev` → 开发环境
    - `staging` → 预发布环境

2. **功能分支预览** - 为每个功能分支创建独立的部署预览

3. **自动化管理** - 无需手动修改 workflow 配置

4. **版本隔离** - 不同分支的构建产物完全隔离

## 注意事项

### 1. 强制推送 (`-f`)

- 每次推送都会覆盖目标分支的历史记录
- 因为构建产物本身不需要保留历史
- 如果需要保留历史，移除 `-f` 参数

### 2. 分支保护

如果目标仓库启用了分支保护规则，可能需要：

- 在目标仓库设置中允许 force push
- 或移除 `-f` 参数，改为追加提交

### 3. SSH 密钥权限

确保 `DEPLOY_SSH_KEY` 有目标仓库的写入权限：

```bash
# 生成 SSH 密钥
ssh-keygen -t ed25519 -C "github-actions-deploy"

# 在目标仓库添加公钥（Deploy Keys）
# 勾选 "Allow write access"
```

## 扩展配置

### 仅在特定分支触发

```yaml
on:
  push:
    branches:
      - main
      - dev
      - staging
```

### 排除特定分支

```yaml
on:
  push:
    branches:
      - '**'
    branches-ignore:
      - 'temp/**'
      - 'test/**'
```

### 多环境部署示例

```yaml
- name: Commit and push
  run: |
    cd target-repo
    # 根据分支名称决定部署行为
    if [[ "${{ github.ref_name }}" == "main" ]]; then
      echo "生产环境部署"
      git checkout -B main
    elif [[ "${{ github.ref_name }}" == "dev" ]]; then
      echo "开发环境部署"
      git checkout -B dev
    else
      echo "功能分支预览"
      git checkout -B preview/${{ github.ref_name }}
    fi
    git add .
    git diff --staged --quiet || git commit -m "Deploy from ${{ github.ref_name }} - ${{ github.sha }}"
    git push -f origin HEAD
```

## 相关文件

- `.github/workflows/deploy-web.yml` - 部署工作流配置

## GitHub Actions 变量参考

- `${{ github.ref_name }}` - 分支名称（如 `main`, `dev`）
- `${{ github.ref }}` - 完整引用（如 `refs/heads/main`）
- `${{ github.sha }}` - 提交 SHA
- `${{ github.actor }}` - 触发用户
- `${{ github.repository }}` - 仓库名称

## 测试建议

1. 先在非主分支测试（如 `dev` 分支）
2. 检查目标仓库是否成功创建同名分支
3. 验证构建产物是否正确部署
4. 确认分支保护规则不会阻止推送

## 相关文档

- [GitHub Actions 上下文变量](https://docs.github.com/en/actions/learn-github-actions/contexts#github-context)
- [Git checkout 文档](https://git-scm.com/docs/git-checkout)
- [GitHub Deploy Keys](https://docs.github.com/en/developers/overview/managing-deploy-keys)

