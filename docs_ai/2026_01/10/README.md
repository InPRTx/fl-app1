# ä»¤ç‰Œåˆ·æ–°ä¼˜åŒ– - å¿«é€Ÿå‚è€ƒ

## âœ… å®Œæˆçš„å·¥ä½œ

### 1. åˆ›å»ºäº†ä»¤ç‰Œåˆ·æ–°é¡µé¢

- æ–‡ä»¶: `/lib/page/auth/token_refresh/auth_token_refresh_page.dart`
- åŠŸèƒ½: ç¾è§‚çš„ UIï¼Œæ˜¾ç¤ºåˆ·æ–°è¿›åº¦ï¼Œæä¾›é‡è¯•å’Œé‡æ–°ç™»å½•é€‰é¡¹

### 2. å¢å¼ºäº† AuthStore

- æ–‡ä»¶: `/lib/store/service/auth/auth_store.dart`
- æ–°å¢åŠŸèƒ½:
    - `onNavigateToTokenRefresh` å›è°ƒ
    - `saveCurrentPath()` æ–¹æ³•
    - `apiRefreshToken(skipNavigation)` å‚æ•°
    - ç½‘ç»œé”™è¯¯æ—¶ä¸å†å¼ºåˆ¶ç™»å‡º

### 3. æ·»åŠ äº†è·¯ç”±é…ç½®

- æ–‡ä»¶: `/lib/router/app_router.dart`
- è·¯å¾„: `/auth/token_refresh?returnPath=xxx`

### 4. é…ç½®äº†ä¸»åº”ç”¨

- æ–‡ä»¶: `/lib/main.dart`
- è®¾ç½®äº†ä»¤ç‰Œåˆ·æ–°é¡µé¢çš„è·³è½¬å›è°ƒ

### 5. ç”Ÿæˆäº†æ–‡æ¡£

- `/docs_ai/2026_01/10/ä»¤ç‰Œåˆ·æ–°é¡µé¢ä¼˜åŒ–.md` - è¯¦ç»†æ–‡æ¡£
- `/docs_ai/2026_01/10/ä»¤ç‰Œåˆ·æ–°é¡µé¢ä½¿ç”¨ç¤ºä¾‹.md` - ä½¿ç”¨ç¤ºä¾‹

## ğŸ¯ ç”¨æˆ·ä½“éªŒæ”¹è¿›

### ä¹‹å‰

- ä»¤ç‰Œåˆ·æ–°å¤±è´¥ â†’ ç›´æ¥è·³è½¬åˆ°ç™»å½•é¡µ â†’ ç”¨æˆ·éœ€è¦é‡æ–°ç™»å½• ğŸ˜”

### ç°åœ¨

- ä»¤ç‰Œåˆ·æ–°å¤±è´¥ â†’ è·³è½¬åˆ°åˆ·æ–°é¡µé¢ â†’ æ˜¾ç¤ºè¿›åº¦å’ŒçŠ¶æ€
- ç”¨æˆ·å¯ä»¥é€‰æ‹©ï¼š
    - âœ… **é‡è¯•** - å¦‚æœæ˜¯ç½‘ç»œé—®é¢˜
    - âœ… **é‡æ–°ç™»å½•** - å¦‚æœç¡®å®è¿‡æœŸ
- åˆ·æ–°æˆåŠŸåè‡ªåŠ¨è¿”å›ä¹‹å‰çš„é¡µé¢ ğŸ˜Š

## ğŸ”§ æŠ€æœ¯è¦ç‚¹

1. **è·³è½¬é€»è¾‘**
   ```dart
   // åœ¨ main.dart ä¸­è®¾ç½®
   AuthStore().onNavigateToTokenRefresh = (String? returnPath) {
     final path = returnPath ?? '/';
     appRouter.pushPath('/auth/token_refresh?returnPath=${Uri.encodeComponent(path)}');
   };
   ```

2. **ä¿å­˜è¿”å›è·¯å¾„**
   ```dart
   // åœ¨ä»»ä½•é¡µé¢ä¸­
   AuthStore().saveCurrentPath(context.router.currentPath);
   ```

3. **åå°é™é»˜åˆ·æ–°**
   ```dart
   // ä½¿ç”¨ skipNavigation: true
   await AuthStore().apiRefreshToken(skipNavigation: true);
   ```

4. **åº”ç”¨å¯åŠ¨æ—¶çš„ä»¤ç‰Œåˆ·æ–°**
   ```dart
   // åœ¨ MyApp çš„ initState ä¸­æ£€æŸ¥
   @override
   void initState() {
     super.initState();
     
     // åœ¨é¦–å¸§æ¸²æŸ“åæ£€æŸ¥æ˜¯å¦éœ€è¦è·³è½¬åˆ°ä»¤ç‰Œåˆ·æ–°é¡µé¢
     WidgetsBinding.instance.addPostFrameCallback((_) {
       AuthStore().checkAndHandleStartupRefresh();
     });
   }
   ```

## ğŸ“± UI é¢„è§ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  [æ·±ç´«è‰²æ¸å˜èƒŒæ™¯]              â”‚
â”‚                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                          â”‚ â”‚
â”‚  â”‚      [åœ†å½¢åŠ è½½åŠ¨ç”»]      â”‚ â”‚
â”‚  â”‚                          â”‚ â”‚
â”‚  â”‚   æ­£åœ¨åˆ·æ–°ç™»å½•ä»¤ç‰Œ...    â”‚ â”‚
â”‚  â”‚                          â”‚ â”‚
â”‚  â”‚      è¯·ç¨å€™...           â”‚ â”‚
â”‚  â”‚                          â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

// åˆ·æ–°å¤±è´¥æ—¶

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  [æ·±ç´«è‰²æ¸å˜èƒŒæ™¯]              â”‚
â”‚                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                          â”‚ â”‚
â”‚  â”‚      [çº¢è‰²é”™è¯¯å›¾æ ‡]      â”‚ â”‚
â”‚  â”‚                          â”‚ â”‚
â”‚  â”‚     ä»¤ç‰Œåˆ·æ–°å¤±è´¥         â”‚ â”‚
â”‚  â”‚ ç™»å½•ä»¤ç‰Œå·²è¿‡æœŸæˆ–æ— æ•ˆ     â”‚ â”‚
â”‚  â”‚     å°è¯•æ¬¡æ•°: 2          â”‚ â”‚
â”‚  â”‚                          â”‚ â”‚
â”‚  â”‚  [é‡è¯•]    [é‡æ–°ç™»å½•]    â”‚ â”‚
â”‚  â”‚                          â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ§ª æµ‹è¯•æ¸…å•

- [ ] **åº”ç”¨å¯åŠ¨æ—¶ä»¤ç‰Œè¿‡æœŸ** â†’ è‡ªåŠ¨è·³è½¬åˆ°åˆ·æ–°é¡µé¢
- [ ] å®šæ—¶å™¨è§¦å‘çš„è‡ªåŠ¨åˆ·æ–°å¤±è´¥ â†’ è·³è½¬åˆ°åˆ·æ–°é¡µé¢
- [ ] åœ¨åˆ·æ–°é¡µé¢ç‚¹å‡»"é‡è¯•" â†’ é‡æ–°åˆ·æ–°ä»¤ç‰Œ
- [ ] åœ¨åˆ·æ–°é¡µé¢ç‚¹å‡»"é‡æ–°ç™»å½•" â†’ è·³è½¬åˆ°ç™»å½•é¡µ
- [ ] åˆ·æ–°æˆåŠŸ â†’ è¿”å›ä¹‹å‰ä¿å­˜çš„é¡µé¢
- [ ] æ²¡æœ‰ä¿å­˜è¿”å›è·¯å¾„æ—¶ â†’ è¿”å›é¦–é¡µ
- [ ] ç½‘ç»œé”™è¯¯æ—¶ â†’ ä¸æ¸…é™¤ä»¤ç‰Œï¼Œå¯ä»¥é‡è¯•
- [ ] 401/403 é”™è¯¯æ—¶ â†’ æ¸…é™¤ä»¤ç‰Œï¼Œè·³è½¬ç™»å½•é¡µ

## ğŸ“ ä»£ç æ£€æŸ¥ç»“æœ

```bash
âœ… flutter analyze - No issues found!
âœ… dart format - All files formatted
âœ… build_runner - Routes generated successfully
```

## ğŸš€ ä¸‹ä¸€æ­¥

ä»£ç å·²ç»å®Œæˆå¹¶é€šè¿‡æ£€æŸ¥ã€‚ä½ å¯ä»¥ï¼š

1. **è¿è¡Œåº”ç”¨æµ‹è¯•**
   ```bash
   flutter run
   ```

2. **æŸ¥çœ‹æ–‡æ¡£**
    - è¯¦ç»†æ–‡æ¡£: `/docs_ai/2026_01/10/ä»¤ç‰Œåˆ·æ–°é¡µé¢ä¼˜åŒ–.md`
    - ä½¿ç”¨ç¤ºä¾‹: `/docs_ai/2026_01/10/ä»¤ç‰Œåˆ·æ–°é¡µé¢ä½¿ç”¨ç¤ºä¾‹.md`

3. **è‡ªå®šä¹‰ UI**
    - ä¿®æ”¹ `/lib/page/auth/token_refresh/auth_token_refresh_page.dart`
    - è°ƒæ•´é¢œè‰²ã€æ–‡å­—ã€å¸ƒå±€ç­‰

4. **æ·»åŠ è·¯ç”±è§‚å¯Ÿå™¨**ï¼ˆå¯é€‰ï¼‰
    - è‡ªåŠ¨ä¿å­˜æ‰€æœ‰é¡µé¢çš„è¿”å›è·¯å¾„
    - å‚è€ƒä½¿ç”¨ç¤ºä¾‹æ–‡æ¡£

## ğŸ’¡ ä½¿ç”¨å»ºè®®

- åœ¨é‡è¦é¡µé¢ï¼ˆå¦‚æ”¯ä»˜ã€è¡¨å•å¡«å†™ç­‰ï¼‰ä¸»åŠ¨ä¿å­˜è¿”å›è·¯å¾„
- å®šæœŸæµ‹è¯•ä»¤ç‰Œåˆ·æ–°æµç¨‹
- ç›‘æ§ä»¤ç‰Œåˆ·æ–°å¤±è´¥æ—¥å¿—ï¼ŒåŠæ—¶å‘ç°é—®é¢˜
- è€ƒè™‘æ·»åŠ åˆ·æ–°æˆåŠŸ/å¤±è´¥çš„åˆ†æç»Ÿè®¡

---

**å®Œæˆæ—¶é—´**: 2026å¹´01æœˆ10æ—¥  
**ä¿®æ”¹æ–‡ä»¶æ•°**: 4ä¸ª  
**æ–°å¢æ–‡ä»¶æ•°**: 3ä¸ª  
**ä»£ç è¡Œæ•°**: ~250è¡Œ  
**æ–‡æ¡£è¡Œæ•°**: ~450è¡Œ

