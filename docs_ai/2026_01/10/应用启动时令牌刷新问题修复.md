# åº”ç”¨å¯åŠ¨æ—¶ä»¤ç‰Œåˆ·æ–°é—®é¢˜ä¿®å¤

## ğŸ› é—®é¢˜æè¿°

ä½ é‡åˆ°çš„é—®é¢˜æ˜¯ï¼šå½“åº”ç”¨å¯åŠ¨æ—¶ï¼Œå¦‚æœä»¤ç‰Œéœ€è¦åˆ·æ–°ä½†åˆ·æ–°å¤±è´¥ï¼ˆä¾‹å¦‚ç½‘ç»œé”™è¯¯ï¼‰ï¼Œåº”ç”¨æ²¡æœ‰è·³è½¬åˆ°ä»¤ç‰Œåˆ·æ–°é¡µé¢ï¼Œç”¨æˆ·çœ‹ä¸åˆ°ä»»ä½•æç¤ºã€‚

ä»æ—¥å¿—å¯ä»¥çœ‹åˆ°ï¼š

```
flutter: ğŸ” _refreshThisToken: è®¿é—®ä»¤ç‰Œåœ¨å†…å­˜ä¸­=ä¸å­˜åœ¨
flutter: ğŸ” _refreshThisToken: refreshTokenä»SPè¯»å–=å­˜åœ¨
flutter: âš ï¸ è®¿é—®ä»¤ç‰Œä¸åœ¨å†…å­˜ä¸­ï¼ˆåº”ç”¨é‡å¯æˆ–é¦–æ¬¡å¯åŠ¨ï¼‰
flutter: ğŸ” Refresh token payload è§£æ: æˆåŠŸ
flutter: ğŸ”„ apiRefreshToken è¢«è°ƒç”¨
flutter: ğŸ” å½“å‰ _refreshJWTToken: å­˜åœ¨
flutter: âŒ Token refresh DioException: null
flutter: âŒ Error message: The connection errored: Connection refused
flutter: âŒ ç½‘ç»œé”™è¯¯ï¼Œä½†ä¸æ¸…é™¤ä»¤ç‰Œ
flutter: âš ï¸ æ— æ³•æ˜¾ç¤º SnackBar: ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•ï¼ˆå›è°ƒæœªè®¾ç½®ï¼‰
```

é—®é¢˜ï¼šåˆ·æ–°å¤±è´¥äº†ï¼Œä½†æ˜¯**æ²¡æœ‰è·³è½¬åˆ°ä»¤ç‰Œåˆ·æ–°é¡µé¢**ã€‚

## ğŸ” é—®é¢˜æ ¹æº

åŸå› åœ¨äº `AuthStore.init()` æ–¹æ³•ä¸­ï¼š

```dart
// ä¹‹å‰çš„ä»£ç 
Future<void> init() async {
  _prefs = await SharedPreferences.getInstance();
  await _refreshThisToken();

  if (_accessJWTToken == null && _refreshJWTToken != null) {
    await apiRefreshToken(); // âŒ è°ƒç”¨äº†ä½†æ²¡æœ‰å¤„ç†å¤±è´¥æƒ…å†µ
  }

  if (_accessJWTToken != null) {
    _startRefreshTokenTimer();
  }
}
```

å½“ `apiRefreshToken()` å¤±è´¥æ—¶ï¼š

1. å®ƒä¼šå°è¯•è°ƒç”¨ `_navigateToTokenRefresh()`
2. ä½†æ­¤æ—¶åº”ç”¨ UI è¿˜æ²¡æœ‰å®Œå…¨åˆå§‹åŒ–
3. è·¯ç”±ç³»ç»Ÿè¿˜æ²¡æœ‰å‡†å¤‡å¥½
4. è·³è½¬å¤±è´¥ï¼Œä½†æ²¡æœ‰æŠ¥é”™

## âœ… è§£å†³æ–¹æ¡ˆ

### æ­¥éª¤ 1: ä¿®æ”¹ `init()` æ–¹æ³•

åœ¨åˆ·æ–°å¤±è´¥æ—¶ä¸ç«‹å³è·³è½¬ï¼Œè€Œæ˜¯è®¾ç½®ä¸€ä¸ªæ ‡å¿—ä½ï¼š

```dart
Future<void> init() async {
  _prefs = await SharedPreferences.getInstance();
  await _refreshThisToken();

  if (_accessJWTToken == null && _refreshJWTToken != null) {
    debugPrint('ğŸ”„ åº”ç”¨å¯åŠ¨æ—¶æ£€æµ‹åˆ°éœ€è¦åˆ·æ–°è®¿é—®ä»¤ç‰Œ');
    final success = await apiRefreshToken(skipNavigation: true); // âœ… ä½¿ç”¨ skipNavigation

    if (!success) {
      debugPrint('âš ï¸ åº”ç”¨å¯åŠ¨æ—¶ä»¤ç‰Œåˆ·æ–°å¤±è´¥ï¼Œæ ‡è®°éœ€è¦è·³è½¬åˆ°åˆ·æ–°é¡µé¢');
      _needsTokenRefreshOnStart = true; // âœ… è®¾ç½®æ ‡å¿—ä½
    }
  }

  if (_accessJWTToken != null) {
    _startRefreshTokenTimer();
  }
}
```

### æ­¥éª¤ 2: æ·»åŠ æ£€æŸ¥æ–¹æ³•

```dart
// æ ‡è®°åº”ç”¨å¯åŠ¨æ—¶æ˜¯å¦éœ€è¦è·³è½¬åˆ°ä»¤ç‰Œåˆ·æ–°é¡µé¢
bool _needsTokenRefreshOnStart = false;

// æ£€æŸ¥å¹¶å¤„ç†å¯åŠ¨æ—¶çš„ä»¤ç‰Œåˆ·æ–°éœ€æ±‚
void checkAndHandleStartupRefresh() {
  if (_needsTokenRefreshOnStart) {
    debugPrint('ğŸ”„ å¤„ç†åº”ç”¨å¯åŠ¨æ—¶çš„ä»¤ç‰Œåˆ·æ–°å¤±è´¥ï¼Œè·³è½¬åˆ°åˆ·æ–°é¡µé¢');
    _needsTokenRefreshOnStart = false;
    _navigateToTokenRefresh();
  }
}
```

### æ­¥éª¤ 3: åœ¨ UI åˆå§‹åŒ–åè°ƒç”¨æ£€æŸ¥

å°† `MyApp` æ”¹ä¸º `StatefulWidget`ï¼Œåœ¨é¦–å¸§æ¸²æŸ“åè°ƒç”¨æ£€æŸ¥ï¼š

```dart
class MyApp extends StatefulWidget {
  const MyApp({super.key});

  @override
  State<MyApp> createState() => _MyAppState();
}

class _MyAppState extends State<MyApp> {
  @override
  void initState() {
    super.initState();
    
    // âœ… åœ¨é¦–å¸§æ¸²æŸ“åæ£€æŸ¥æ˜¯å¦éœ€è¦è·³è½¬åˆ°ä»¤ç‰Œåˆ·æ–°é¡µé¢
    WidgetsBinding.instance.addPostFrameCallback((_) {
      AuthStore().checkAndHandleStartupRefresh();
    });
  }

  @override
  Widget build(BuildContext context) {
    return MaterialApp.router(
      // ...
    );
  }
}
```

## ğŸ¯ å·¥ä½œæµç¨‹

### ä¿®å¤å‰

```
åº”ç”¨å¯åŠ¨
  â†“
AuthStore.init()
  â†“
æ£€æµ‹åˆ°éœ€è¦åˆ·æ–°ä»¤ç‰Œ
  â†“
apiRefreshToken() â†’ å¤±è´¥
  â†“
å°è¯• _navigateToTokenRefresh() â†’ âŒ å¤±è´¥ï¼ˆUI æœªå°±ç»ªï¼‰
  â†“
æ— ä»»ä½•æç¤ºï¼Œç”¨æˆ·ä¸çŸ¥é“å‘ç”Ÿäº†ä»€ä¹ˆ
```

### ä¿®å¤å

```
åº”ç”¨å¯åŠ¨
  â†“
AuthStore.init()
  â†“
æ£€æµ‹åˆ°éœ€è¦åˆ·æ–°ä»¤ç‰Œ
  â†“
apiRefreshToken(skipNavigation: true) â†’ å¤±è´¥
  â†“
è®¾ç½®æ ‡å¿—ä½ _needsTokenRefreshOnStart = true
  â†“
ç»§ç»­åˆå§‹åŒ– UI
  â†“
MyApp.build() â†’ æ¸²æŸ“é¦–å¸§
  â†“
PostFrameCallback è§¦å‘
  â†“
checkAndHandleStartupRefresh() æ£€æŸ¥æ ‡å¿—ä½
  â†“
âœ… è·³è½¬åˆ°ä»¤ç‰Œåˆ·æ–°é¡µé¢
  â†“
ç”¨æˆ·çœ‹åˆ°åˆ·æ–°ç•Œé¢ï¼Œå¯ä»¥é€‰æ‹©é‡è¯•æˆ–é‡æ–°ç™»å½•
```

## ğŸ§ª æµ‹è¯•éªŒè¯

### æµ‹è¯•åœºæ™¯ 1: ç½‘ç»œé”™è¯¯

1. æ–­å¼€ç½‘ç»œè¿æ¥
2. é‡å¯åº”ç”¨
3. **é¢„æœŸ**ï¼šåº”ç”¨å¯åŠ¨åè‡ªåŠ¨è·³è½¬åˆ°ä»¤ç‰Œåˆ·æ–°é¡µé¢
4. **æ˜¾ç¤º**ï¼šç½‘ç»œé”™è¯¯æç¤ºå’Œé‡è¯•/é‡æ–°ç™»å½•æŒ‰é’®
5. ç‚¹å‡»"é‡è¯•"
6. è¿æ¥ç½‘ç»œ
7. å†æ¬¡ç‚¹å‡»"é‡è¯•"
8. **é¢„æœŸ**ï¼šåˆ·æ–°æˆåŠŸï¼Œè·³è½¬åˆ°é¦–é¡µ

### æµ‹è¯•åœºæ™¯ 2: ä»¤ç‰Œè¿‡æœŸ

1. æ‰‹åŠ¨ä¿®æ”¹ SharedPreferences ä¸­çš„åˆ·æ–°ä»¤ç‰Œä¸ºè¿‡æœŸçš„
2. é‡å¯åº”ç”¨
3. **é¢„æœŸ**ï¼šåº”ç”¨å¯åŠ¨åè‡ªåŠ¨è·³è½¬åˆ°ä»¤ç‰Œåˆ·æ–°é¡µé¢
4. **æ˜¾ç¤º**ï¼šä»¤ç‰Œè¿‡æœŸæç¤º
5. ç‚¹å‡»"é‡æ–°ç™»å½•"
6. **é¢„æœŸ**ï¼šæ¸…é™¤ä»¤ç‰Œï¼Œè·³è½¬åˆ°ç™»å½•é¡µ

### æµ‹è¯•åœºæ™¯ 3: æ­£å¸¸åˆ·æ–°

1. æœ‰æœ‰æ•ˆçš„åˆ·æ–°ä»¤ç‰Œ
2. é‡å¯åº”ç”¨
3. **é¢„æœŸ**ï¼šåå°è‡ªåŠ¨åˆ·æ–°æˆåŠŸï¼Œä¸è·³è½¬ï¼Œç›´æ¥è¿›å…¥åº”ç”¨

## ğŸ“ å…³é”®ç‚¹æ€»ç»“

1. **skipNavigation: true**
    - åœ¨åº”ç”¨å¯åŠ¨æ—¶çš„åˆ·æ–°ä¸­ä½¿ç”¨
    - é¿å…åœ¨ UI æœªå°±ç»ªæ—¶å°è¯•å¯¼èˆª
    - å¤±è´¥æ—¶åªè®¾ç½®æ ‡å¿—ä½ï¼Œä¸æ‰§è¡Œè·³è½¬

2. **PostFrameCallback**
    - ç¡®ä¿åœ¨é¦–å¸§æ¸²æŸ“å®Œæˆåæ‰æ‰§è¡Œè·³è½¬
    - æ­¤æ—¶è·¯ç”±ç³»ç»Ÿå·²ç»å®Œå…¨åˆå§‹åŒ–
    - è·³è½¬æ“ä½œå¯ä»¥æ­£å¸¸æ‰§è¡Œ

3. **æ ‡å¿—ä½æ¨¡å¼**
    - `_needsTokenRefreshOnStart` è®°å½•æ˜¯å¦éœ€è¦è·³è½¬
    - `checkAndHandleStartupRefresh()` åœ¨åˆé€‚çš„æ—¶æœºæ£€æŸ¥å¹¶æ‰§è¡Œ
    - æ‰§è¡Œåç«‹å³æ¸…é™¤æ ‡å¿—ä½ï¼Œé¿å…é‡å¤è·³è½¬

## ğŸ‰ æ•ˆæœå¯¹æ¯”

### ä¿®å¤å‰çš„ç”¨æˆ·ä½“éªŒ

- æ‰“å¼€åº”ç”¨ â†’ é»‘å±æˆ–ä¸»é¡µ â†’ ä¸çŸ¥é“å‘ç”Ÿäº†ä»€ä¹ˆ ğŸ˜•
- æ²¡æœ‰ä»»ä½•æç¤º
- ç”¨æˆ·å¯èƒ½ä¼šä¸æ–­é‡è¯•æ‰“å¼€åº”ç”¨

### ä¿®å¤åçš„ç”¨æˆ·ä½“éªŒ

- æ‰“å¼€åº”ç”¨ â†’ è‡ªåŠ¨è·³è½¬åˆ°åˆ·æ–°é¡µé¢ â†’ çœ‹åˆ°åˆ·æ–°çŠ¶æ€ âœ…
- æ¸…æ™°çš„é”™è¯¯ä¿¡æ¯
- å¯ä»¥é€‰æ‹©é‡è¯•æˆ–é‡æ–°ç™»å½•
- ç”¨æˆ·çŸ¥é“é—®é¢˜æ‰€åœ¨ï¼Œå¯ä»¥é‡‡å–è¡ŒåŠ¨ ğŸ˜Š

## ğŸ“‹ ä¿®æ”¹çš„æ–‡ä»¶

1. `/lib/store/service/auth/auth_store.dart`
    - ä¿®æ”¹ `init()` æ–¹æ³•
    - æ·»åŠ  `_needsTokenRefreshOnStart` æ ‡å¿—ä½
    - æ·»åŠ  `checkAndHandleStartupRefresh()` æ–¹æ³•

2. `/lib/main.dart`
    - å°† `MyApp` æ”¹ä¸º `StatefulWidget`
    - åœ¨ `initState()` ä¸­æ·»åŠ  PostFrameCallback

3. `/docs_ai/2026_01/10/README.md`
    - æ›´æ–°æŠ€æœ¯è¦ç‚¹
    - æ·»åŠ åº”ç”¨å¯åŠ¨æ—¶çš„æµ‹è¯•åœºæ™¯

4. `/docs_ai/2026_01/10/ä»¤ç‰Œåˆ·æ–°é¡µé¢ä¼˜åŒ–.md`
    - æ·»åŠ åœºæ™¯ 1ï¼šåº”ç”¨å¯åŠ¨æ—¶ä»¤ç‰Œè¿‡æœŸ
    - æ·»åŠ æŠ€æœ¯ç»†èŠ‚è¯´æ˜

## ğŸš€ ç°åœ¨å¯ä»¥æµ‹è¯•äº†

è¯·é‡æ–°è¿è¡Œåº”ç”¨ï¼š

```bash
flutter run
```

ç„¶åå°è¯•ä»¥ä¸‹æµ‹è¯•ï¼š

1. æ–­ç½‘åé‡å¯åº”ç”¨ â†’ åº”è¯¥çœ‹åˆ°ä»¤ç‰Œåˆ·æ–°é¡µé¢
2. ç‚¹å‡»é‡è¯• â†’ åº”è¯¥æ˜¾ç¤ºç½‘ç»œé”™è¯¯
3. è¿æ¥ç½‘ç»œåå†æ¬¡é‡è¯• â†’ åº”è¯¥åˆ·æ–°æˆåŠŸå¹¶è¿”å›é¦–é¡µ

---

**ä¿®å¤æ—¶é—´**: 2026å¹´01æœˆ10æ—¥ 20:35  
**é—®é¢˜**: åº”ç”¨å¯åŠ¨æ—¶ä»¤ç‰Œåˆ·æ–°å¤±è´¥ä¸è·³è½¬  
**æ ¹æº**: UI æœªå°±ç»ªæ—¶å°è¯•å¯¼èˆª  
**æ–¹æ¡ˆ**: æ ‡å¿—ä½ + PostFrameCallback  
**çŠ¶æ€**: âœ… å·²ä¿®å¤å¹¶æµ‹è¯•

