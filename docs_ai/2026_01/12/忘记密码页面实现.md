# 忘记密码页面实现

## 日期

2026-01-12

## 概述

参照 Vue 前端的忘记密码页面模板，为 Flutter 应用创建了完整的密码重置功能页面，包含 POW 验证码、邮箱验证码和密码重置功能。

## 功能特性

### 1. 表单字段

#### 邮箱地址

- ✅ 必填字段
- ✅ 格式验证（正则表达式）
- ✅ 白名单验证（支持 97 个主流邮箱服务商）
- ✅ 实时验证
- ✅ 显示支持的邮箱后缀提示

#### 邮箱验证码

- ✅ 6位数字验证码
- ✅ 发送验证码按钮（60秒倒计时）
- ✅ 需要先完成 POW 验证
- ✅ 重新发送功能
- ✅ 成功发送后显示提示信息

#### 新密码

- ✅ 必填字段
- ✅ 长度限制：8-50个字符
- ✅ 强度要求：必须包含大小写字母和数字
- ✅ 显示/隐藏密码切换

#### 确认新密码

- ✅ 必填字段
- ✅ 与新密码一致性验证
- ✅ 显示/隐藏密码切换

### 2. POW 验证码

- ✅ 集成 POW 验证系统
- ✅ 三态 UI：未验证/验证中/已验证
- ✅ 验证成功后显示绿色成功标识
- ✅ 支持刷新重新验证
- ✅ 错误提示和处理
- ✅ 仅在发送邮件验证码时需要

### 3. 安全特性

#### 表单验证

- ✅ 所有字段都有完整的验证规则
- ✅ 实时验证反馈
- ✅ 清晰的错误提示

#### POW 验证

- ✅ 发送验证码前必须完成 POW 验证
- ✅ 完整的错误处理
- ✅ 防止滥用

#### 密码安全

- ✅ 强密码要求
- ✅ 密码可见性切换
- ✅ 确认密码验证

### 4. 用户体验

#### 视觉反馈

- ✅ 震动动画（表单验证失败时）
- ✅ 加载状态指示
- ✅ 成功/失败提示消息
- ✅ 倒计时显示（发送验证码）
- ✅ 验证码发送成功提示框

#### 错误处理

- ✅ 网络错误提示
- ✅ API 错误提示
- ✅ 表单验证错误提示
- ✅ 友好的用户提示

#### 导航

- ✅ 重置成功后自动跳转登录页
- ✅ "已经有账号？登录"链接
- ✅ 1秒延迟自动跳转

## 代码结构

### 页面文件

```
lib/page/auth/reset_password/
└── auth_reset_password_page.dart
```

### 路由配置

**app_router.dart**:

```dart
import 'package:fl_app1/page/auth/reset_password/auth_reset_password_page.dart';

AutoRoute
(
page: AuthResetPasswordRoute.page,
path: 'auth/reset-password',
)
,
```

### 核心类

#### AuthResetPasswordPage

- StatefulWidget 主页面
- 表单状态管理
- 验证码逻辑
- API 调用

## API 集成

### 1. 发送邮箱验证码

**接口**: `POST /api/v2/auth/account_reset_password/request-email-code`

**参数模型**: `RequestEmailCodeParamsModel`

```dart
{email
:
String
, // 邮箱地址
verifyToken
:
String
, // POW验证令牌
}
```

**响应**: `ErrorResponse`

```dart
{isSuccess
:
bool
,
message
:
String
,
}
```

### 2. 重置密码

**接口**: `POST /api/v2/auth/account_reset_password/`

**参数模型**: `AccountResetPasswordParamsModel`

```dart
{email: String?, // 邮箱地址（可选）
emailCode: String, // 邮箱验证码
password: String
, // 新密码
verifyToken
:
String
?
, // POW验证令牌（可选）
}
```

**响应**: `ErrorResponse`

```dart
{isSuccess
:
bool
,
message
:
String
,
}
```

## UI 组件

### 表单布局

```
Card
├── 标题：找回密码
├── 副标题：在下面输入您的信息以找回您的帐户
├── 邮箱输入框
├── POW 验证区域
├── 发送验证码按钮
├── 验证码成功提示（可选）
├── 邮箱验证码输入框
├── 新密码输入框
├── 确认新密码输入框
├── 重置密码按钮
└── 登录链接
```

## 用户流程

### 完整的重置密码流程

```
1. 输入邮箱地址
2. 点击"获取POW验证"
   → 等待计算完成（约3-8秒）
   → 显示绿色"验证成功"
3. 点击"发送验证码"
   → 使用 POW 令牌调用 API
   → 显示"验证码已发送，请查收邮箱"
   → 开始60秒倒计时
4. 输入收到的6位验证码
5. 输入新密码（8-50字符，含大小写+数字）
6. 确认新密码
7. 点击"重置密码"
   → 调用重置密码 API
   → 成功后显示提示
   → 1秒后自动跳转登录页
```

## 集成步骤

### 1. 登录页入口

已在 `auth_login_page.dart` 添加忘记密码链接：

```dart
TextButton
(
onPressed: () => context.router.pushPath('/auth/reset-password'),
child: const Text('
忘记密码？
'
)
,
)
,
```

### 2. 路由配置

已添加路由：

```dart
AutoRoute
(
page: AuthResetPasswordRoute.page,
path: 'auth/reset-password',
)
,
```

## 验证结果

### Flutter Analyze

```bash
flutter analyze
# 25 issues found (全部为 info 级别)
# ✅ 0 errors
# ✅ 0 warnings
```

### 路由生成

```bash
flutter pub run build_runner build --delete-conflicting-outputs
# ✅ 成功生成 AuthResetPasswordRoute
```

## 代码规范遵循

- ✅ 使用明确的类型声明
- ✅ 所有变量使用 `final`
- ✅ 避免使用 `var`
- ✅ 完整的错误处理
- ✅ 清晰的用户提示
- ✅ 组件化设计
- ✅ 单例模式（CaptchaService）
- ✅ 遵循 Flutter 官方代码规范

## 与 Vue 版本对比

| 功能     | Vue 版本   | Flutter 版本 | 状态         |
|--------|----------|------------|------------|
| 邮箱验证   | ✅        | ✅          | 完成         |
| 邮箱白名单  | ❌        | ✅          | Flutter 独有 |
| 邮箱验证码  | ✅        | ✅          | 完成         |
| 倒计时功能  | ✅        | ✅          | 完成         |
| 密码强度验证 | ✅        | ✅          | 完成         |
| 确认密码   | ✅        | ✅          | 完成         |
| 成功提示   | ✅        | ✅          | 完成         |
| POW 验证 | ❌（使用旧验证） | ✅          | Flutter 独有 |
| 震动动画   | ✅        | ✅          | 完成         |
| 自动跳转   | ✅        | ✅          | 完成         |

## 特色功能

Flutter 版本相比 Vue 版本的改进：

1. **POW 验证码集成** - 更强的安全性
2. **邮箱白名单显示** - 用户知道支持哪些邮箱
3. **震动动画反馈** - 更好的用户体验
4. **类型安全** - Dart 的强类型系统
5. **统一的状态管理** - 清晰的状态流转
6. **Material Design** - 原生 Material UI
7. **验证码发送成功提示框** - 视觉反馈更明显

## 测试场景

### 场景 1：正常重置密码流程

```
1. 输入邮箱：test@gmail.com
   → 显示：支持的邮箱后缀：gmail.com, yahoo.com... 等97个
2. 点击"获取POW验证"
   → 显示：正在计算POW验证码...
   → 完成：验证成功（绿色）
3. 点击"发送验证码"
   → 显示：验证码已发送到您的邮箱
   → 显示绿色提示框："验证码已发送，请查收邮箱。"
   → 开始60秒倒计时
4. 输入验证码：123456
5. 输入新密码：NewPass123
6. 确认密码：NewPass123
7. 点击"重置密码"
   → 成功：显示"密码重置成功"
   → 1秒后跳转登录页面
```

### 场景 2：邮箱不在白名单

```
1. 输入邮箱：test@example.com
   → 错误：邮箱格式不正确或后缀 @example.com 不在白名单内
2. 查看帮助文本
   → 显示：支持的邮箱后缀：gmail.com, yahoo.com... 等97个
3. 修改邮箱：test@gmail.com
   → 错误消失
```

### 场景 3：密码验证

```
1. 输入新密码：123456
   → 错误：密码至少8个字符
2. 输入新密码：12345678
   → 错误：密码必须包含大小写字母和数字
3. 输入新密码：Abc12345
   → 正确：无错误
4. 输入确认密码：Abc12346
   → 错误：两次密码不一致
5. 输入确认密码：Abc12345
   → 正确：无错误
```

### 场景 4：未获取 POW 验证

```
1. 输入邮箱：test@gmail.com
2. 直接点击"发送验证码"（未获取 POW）
   → 按钮禁用（灰色）
   → 提示："请先完成POW验证码验证"
```

### 场景 5：重置失败处理

```
1. 完成所有输入
2. 点击"重置密码"
   → 失败：验证码错误
   → 显示错误提示
   → 表单震动
3. 修改验证码
4. 再次点击"重置密码"
   → 成功或继续失败处理
```

## 错误处理

### 网络错误

```dart
on DioException
catch
(
e) {
final String message = e.response?.data?['message'] ?? '默认错误消息';
ScaffoldMessenger.of(context).showSnackBar(...);
}
```

### 表单验证错误

```dart
if (!isValid) {
_triggerShake(); // 触发震动动画
return;
}
```

### API 错误

```dart
if (result.isSuccess) {
// 成功处理
} else {
// 显示 API 返回的错误消息
ScaffoldMessenger.of(context).showSnackBar(...);
_triggerShake();
}
```

## 总结

成功创建了功能完整、体验优秀的忘记密码页面：

- ✅ 完整的表单验证
- ✅ POW 验证码集成
- ✅ 邮箱白名单验证
- ✅ 友好的用户体验
- ✅ 清晰的错误处理
- ✅ 响应式设计
- ✅ 遵循项目规范
- ✅ 自动跳转功能

忘记密码页面已经准备就绪，可以投入使用！

## 文档版本

v1.0 - 2026-01-12

