# 修复节点管理页面类型错误

## 日期

2026-01-12

## 文件

`lib/page/low_admin/ss_node/low_admin_ss_node_page.dart`

## 问题描述

代码中存在3个类型错误：

1. **VmessConfig 类型错误**：使用了错误的类型名称
2. **SsrConfig 类型错误**：使用了错误的类型名称
3. **UserGroupHost 映射类型不匹配**：使用了 Pydantic 版本的类型，但应该使用非 Pydantic 版本

## 错误详情

### 错误 1 & 2: VmessConfig 和 SsrConfig 类型名称错误

**位置**: 第 910 行和第 919 行

**原因**:

- VmessConfig 使用了正确的类型名
- SsrConfig 使用了错误的类型名 `WebSubFastapiModelsDatabaseModelTableSsNodeSsNodeNodeConfigSsrConfig`

**正确类型**:

- VmessConfig: `WebSubFastapiModelsDatabaseModelTableSsNodePydanticSsNodePydanticNodeConfigVmessConfig`
- SsrConfig: `WebSubFastapiModelsDatabaseModelTableSsNodePydanticSsNodePydanticNodeConfigSsrConfig`

### 错误 3: UserGroupHost 映射类型不匹配

**位置**: 第 1016 行 `_parseUserGroupHost` 方法

**原因**:
使用了 Pydantic 版本的 UserGroupHostDict:

```dart
Map<String, WebSubFastapiModelsDatabaseModelTableSsNodePydanticSsNodePydanticUserGroupHostSsNodeUserGroupHostDict>
```

但 `UserGroupHostInput` 实际需要的是非 Pydantic 版本:

```dart
Map<String, WebSubFastapiModelsDatabaseModelTableSsNodeSsNodeUserGroupHostSsNodeUserGroupHostDict>
```

## 修复方案

### 1. 修复 SsrConfig 类型名称

**修改前**:

```dart
ssrConfig: _isSsr
?
WebSubFastapiModelsDatabaseModelTableSsNodeSsNodeNodeConfigSsrConfig
(
// ...
): null
,
```

**修改后**:

```dart
ssrConfig: _isSsr
?
WebSubFastapiModelsDatabaseModelTableSsNodePydanticSsNodePydanticNodeConfigSsrConfig
(
host: _data.ssrHost,
port: _data.ssrPort,
password: _data.ssrPassword,
method: _data.ssrMethod,
protocol: _data.ssrProtocol,
protocolParam: _data.ssrProtocolParam,
obfs: _data.ssrObfs,
obfsParam: _data.ssrObfsParam,
)
    : null,
```

### 2. 修复 UserGroupHost 映射类型

**修改前**:

```dart

final Map<String, UserGroupHostDictInput> map = decoded.map((key, value) {
  // ...
  return MapEntry(
    key,
    UserGroupHostDictInput.fromJson(value),
  );
});
```

**修改后**:

```dart
final Map<String, WebSubFastapiModelsDatabaseModelTableSsNodeSsNodeUserGroupHostSsNodeUserGroupHostDict> map = decoded.map((key, value) {
  if (value is! Map<String, dynamic>) {
    throw const FormatException('每个用户组必须是对象');
  }
  return MapEntry(
    key,
    WebSubFastapiModelsDatabaseModelTableSsNodeSsNodeUserGroupHostSsNodeUserGroupHostDict.fromJson(value),
  );
});
```

## 验证结果

运行 `flutter analyze` 后无错误输出，所有类型错误已修复。

## 关键点总结

1. ✅ API 模型在提交数据时，配置相关的类型需要使用 **Pydantic** 版本（带 `Pydantic` 路径）
2. ✅ UserGroupHost 的字典类型需要使用**非 Pydantic** 版本（不带 `Pydantic` 路径）
3. ✅ 遵循 API 自动生成代码的类型定义，确保类型完全匹配

## 类型命名规则

- **Pydantic 版本**（用于提交数据）:
    - `WebSubFastapiModelsDatabaseModelTableSsNodePydanticSsNodePydantic*`

- **非 Pydantic 版本**（用于读取数据和部分嵌套结构）:
    - `WebSubFastapiModelsDatabaseModelTableSsNodeSsNode*`

